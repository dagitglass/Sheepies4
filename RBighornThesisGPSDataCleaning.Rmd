---
title: "Cleaning the GPS Data"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/AllData3920")
```

### Cutting the GPS Data

## Subsetting by Range & Individual Sheep ID

First, I uploaded the GPS data.  I checked for duplicates - there were none. Then, I subset the data for only the mountain ranges that I am interested in: South Bristols (BrsS), Marbles (Marb), Nopah (Nopa), Castle-Piute (CMPR), and Newberry-Rodman-Ord (NROM). Then I subset to only the individual bighorn that I am interested in - those with fix rates of 4 hours or less.

A list of bighorn whose collars are every four hours:

Marbles: BHS_1581 F, BHS_1595 F (died on 8/5), BHS_1588 F
South Bristols: BHS_1580 F (before 2019-07-24 04:00, after 1 hour), 
Nopah: BHS_1738 F
CMPR: none
NROM: BHS_1568 F (went to community center), BHS_1565 F, BHS_1567 F, BHS_1564 F, BHS_1677 F

***am not including NROM BHS_1563M b/c travels into East Ord)
*** SBrs BHS_1580 2019-07-24 4:00 switches from 4 hour to 1 hour, holds steady on that until the end-- COULD INCLUDE IN 1 HOUR FIX Rate


A list of bighorn whose collars are every hour or less:

Marbles: BHS_1589 F (very beginning every four hours?), BHS_1584 F, BHS_1582 F, BHS_1577 F, BHS_1683 M, BHS_1682 M, BHS_1684 M (died on 8/17)
South Bristols: BHS_1688 M, BHS_1685 M, BHS_1689 M, BHS_1687 F, BHS_1686 M, BHS_1580F(after 2019-07-24 04:00)
Nopah: BHS_1736 F, BHS_1740 F, BHS_1739 M
CMPR: BHS_1730 F, BHS_1733 F
NROM: none

```{r}
allgpsdata <- read.csv("AllGPSData20190501to20190912.csv", header = TRUE, sep = ",")
# str(allgpsdata)
library(tidyverse)
summary(duplicated(allgpsdata))
rangegpsdata <- allgpsdata[allgpsdata$MountainRange == "BrsS" | allgpsdata$MountainRange == "Marb" | allgpsdata$MountainRange == "Nopa" | allgpsdata$MountainRange == "CMPR" | allgpsdata$MountainRange == "NROM", ]
# View(rangegpsdata)
# str(rangegpsdata)
rangeidgpsdata <- rangegpsdata[rangegpsdata$KI_Known_ID == "BHS_1581" | rangegpsdata$KI_Known_ID == "BHS_1595" | rangegpsdata$KI_Known_ID == "BHS_1588" | rangegpsdata$KI_Known_ID == "BHS_1580" | rangegpsdata$KI_Known_ID == "BHS_1738" | rangegpsdata$KI_Known_ID == "BHS_1568" | rangegpsdata$KI_Known_ID == "BHS_1565" | rangegpsdata$KI_Known_ID == "BHS_1567" | rangegpsdata$KI_Known_ID == "BHS_1564" | rangegpsdata$KI_Known_ID == "BHS_1677" | rangegpsdata$KI_Known_ID == "BHS_1589" | rangegpsdata$KI_Known_ID == "BHS_1584" | rangegpsdata$KI_Known_ID == "BHS_1582" | rangegpsdata$KI_Known_ID == "BHS_1577" | rangegpsdata$KI_Known_ID == "BHS_1683" | rangegpsdata$KI_Known_ID == "BHS_1682" | rangegpsdata$KI_Known_ID == "BHS_1684" | rangegpsdata$KI_Known_ID == "BHS_1688" | rangegpsdata$KI_Known_ID == "BHS_1685" | rangegpsdata$KI_Known_ID == "BHS_1689" | rangegpsdata$KI_Known_ID == "BHS_1687" | rangegpsdata$KI_Known_ID == "BHS_1686" | rangegpsdata$KI_Known_ID == "BHS_1736" | rangegpsdata$KI_Known_ID == "BHS_1740" | rangegpsdata$KI_Known_ID == "BHS_1739" | rangegpsdata$KI_Known_ID == "BHS_1730" | rangegpsdata$KI_Known_ID == "BHS_1733", ]
# View(rangeidgpsdata)
rangeidgpsdata$TimeLocal <- as.character(rangeidgpsdata$TimeLocal)
rangeidgpsdata$DateTimeLocalTest <- rangeidgpsdata$DateTimeLocal
library(lubridate)
rangeidgpsdata$DateTimeLocalTest <- strptime(rangeidgpsdata$DateTimeLocalTest, "%m/%d/%Y %H:%M")
rangeidgpsdata$DateTimeLocalTestct <- as.POSIXct(rangeidgpsdata$DateTimeLocalTest, tz = "America/Los_Angeles", format = "%m/%d/%Y %H:%M")

```
Subsetting the data to when I had camera data for

I next subset the data to the time periods that I had camera data for. Keeping with my visitation analyses, I cut the GPS data to only include days when the whole 24-hour had camera coverage, and camera coverage was complete.

Marbles:
2019-05-18 - 2019-05-24 = 7
2019-06-05 - 2019-06-11 = 7
2019-06-19 - 2019-06-22 = 4
2019-06-26 - 2019-06-29 = 4
2019-07-11 - 2019-07-13 = 3
2019-07-18 - 2019-07-24 = 7
2019-08-01 - 2019-08-03 = 3
2019-08-07 - 2019-08-09 = 3

South Bristols:
2019-06-05 - 2019-06-15
2019-06-19 - 2019-07-28
2019-08-02 - 2019-08-11

Nopah:
2019-06-07 - 2019-06-12
2019-06-26 - 2019-07-07
2019-07-17 - 2019-07-28
2019-07-30 - 2019-08-06

Castle Piutes:
2019-05-24 - 2019-05-30
2019-06-21 - 2019-06-26
2019-07-12 - 2019-07-14
2019-07-31 - 2019-08-03
2019-08-06 - 2019-08-14

NROM:
2019-06-28 - 2019-07-01
2019-07-10 - 2019-07-12
2019-07-21
2019-08-09 - 2019-08-18
2019-08-21

```{r}
marbidgpsdata <- rangeidgpsdata[rangeidgpsdata$MountainRange == "Marb", ]
marbidgpsdatacut <- marbidgpsdata[(marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-05-18 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-05-24 23:59:59")) | (marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-05 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-06-11 23:59:59")) | (marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-19 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-06-22 23:59:59")) | (marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-26 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-06-29 23:59:59")) | (marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-11 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-13 23:59:59")) | (marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-18 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-24 23:59:59")) | (marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-08-01 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-03 23:59:59")) | (marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-08-07 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-09 23:59:59")), ]

sbrsidgpsdata <- rangeidgpsdata[rangeidgpsdata$MountainRange == "BrsS", ]
sbrsidgpsdatacut <- sbrsidgpsdata[(sbrsidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-05 00:00:00") & sbrsidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-06-15 23:59:59")) | (sbrsidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-19 00:00:00") & sbrsidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-28 23:59:59")) | (sbrsidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-08-02 00:00:00") & sbrsidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-11 23:59:59")), ]

cmpridgpsdata <- rangeidgpsdata[rangeidgpsdata$MountainRange == "CMPR", ]
cmpridgpsdatacut <- cmpridgpsdata[(cmpridgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-05-24 00:00:00") & cmpridgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-05-30 23:59:59")) | (cmpridgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-21 00:00:00") & cmpridgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-06-26 23:59:59")) | (cmpridgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-12 00:00:00") & cmpridgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-14 23:59:59")) | (cmpridgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-31 00:00:00") & cmpridgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-03 23:59:59")) | (cmpridgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-08-06 00:00:00") & cmpridgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-14 23:59:59")), ]

nopaidgpsdata <- rangeidgpsdata[rangeidgpsdata$MountainRange == "Nopa", ]
nopaidgpsdatacut <- nopaidgpsdata[(nopaidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-07 00:00:00") & nopaidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-06-12 23:59:59")) | (nopaidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-26 00:00:00") & nopaidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-07 23:59:59")) | (nopaidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-17 00:00:00") & nopaidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-28 23:59:59")) | (nopaidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-30 00:00:00") & nopaidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-06 23:59:59")), ]

nromidgpsdata <- rangeidgpsdata[rangeidgpsdata$MountainRange == "NROM", ]
nromidgpsdatacut <- nromidgpsdata[(nromidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-28 00:00:00") & nromidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-01 23:59:59")) | (nromidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-10 00:00:00") & nromidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-12 23:59:59")) | (nromidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-21 00:00:00") & nromidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-21 23:59:59")) | (nromidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-08-09 00:00:00") & nromidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-18 23:59:59")) | (nromidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-08-21 00:00:00") & nromidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-21 23:59:59")), ]

allidgpsdatacut <- rbind(marbidgpsdatacut, sbrsidgpsdatacut, cmpridgpsdatacut, nopaidgpsdatacut, nromidgpsdatacut)
# I removed the entries with missing latitudes or longitudes from the dataset.
allidgpsdatacut1 <- allidgpsdatacut[is.na(allidgpsdatacut$Latitude) == FALSE, ]
allidgpsdatacut2 <- allidgpsdatacut1[is.na(allidgpsdatacut1$Longitude) == FALSE, ]

#Removed GPS points for after 1595 died. RIP.
not1595 <- allidgpsdatacut2[allidgpsdatacut2$KI_Known_ID != "BHS_1595", ]
is1595 <- allidgpsdatacut2[allidgpsdatacut2$KI_Known_ID == "BHS_1595", ]
is1595cut <- is1595[(is1595$DateTimeLocalTestct < as.POSIXct("2019-08-05 00:00:00")), ]
allidgpsdatacut3 <- rbind(not1595, is1595cut)

```
Subsetting to every hour and four hour

To remove the locations that were taken at 20 minute fix rates, I subset by the rows where the minutes were between 55 and 10. The number of rows before subsetting was 21172 while the number of rows after subsetting was 17691, demonstrating that rows with locations taken not close to the hour mark were removed. 


```{r}

# Removing the 20 min fixes
# rangeidhour includes collars on both 1-hour and 4-hour fix rates
rangeidhour <- subset(allidgpsdatacut3, format(allidgpsdatacut3$DateTimeLocalTest, "%M") %in% c('00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '55', '56', '57', '58', '59', '54', '53', '52', '51', '50'))
## I double checked the sheep that are every four hours to make sure that they are on a 0-4-8-12-16-20-24 schedule. They are all.
# rangeidfourhour <- subset(rangeidhour, format(rangeidhour$DateTimeLocalTest, "%H") %in% c('00', '04', '08', '12', '16', '20', '24'))
# Including every hour as ~18,000 gps observations, including only every four hour as ~6,000 observations. Both include 28 individual sheep. 


## Will need to do the amount of time between points for both time schedules before doing any of my 4 gps movement types.


```

### Cleaning the GPS Data

## Mapping the GPS Data

I mapped the GPS data to be able to visually check how cleaning the data changed the sheep movement tracks.

```{r}
# Making an individually identifiable ID for each point
rangeidhour$IndPoint <- paste(rangeidhour$KI_Known_ID, rangeidhour$DateTimeLocalTestct)

library(maptools)
plotattempt <- SpatialPointsDataFrame(rangeidhour[6:5], rangeidhour[21])
plot(plotattempt)

# library(adehabitatLT)
# ltrangeidhour <- as.ltraj(xy = rangeidhour[, c("Latitude", "Longitude")], date = rangeidhour$DateTimeLocalTestct, id = rangeidhour$IndPoint)
# View(ltrangeidhour)

# data.lt_Desert <- as.ltraj(xy = DesertDataDanielleNoDuplicates[, c("UTME", "UTMN")], date = DesertDataDanielleNoDuplicates$DateTimeC, id = DesertDataDanielleNoDuplicates$ID)
#maybe need to convert to UTM first?

library(moveHMM)

names(rangeidhour)[names(rangeidhour) == "KI_Known_ID"] <- "ID"
rangeidhour1 <- rangeidhour[with(rangeidhour, order(ID, DateTimeLocalTestct)), ]
prangeidhour <- prepData(rangeidhour1, type = "LL", coordNames = c("Longitude", "Latitude"))
plot(prangeidhour, compact = T)

library(ggmap)
# plotSat(prangeidhour, zoom = 8)
# Doesn't work because need Google API key????

# Marbles before cleaning
marbidhour <- rangeidhour1[rangeidhour1$MountainRange == "Marb", ]
pmarbidhour <- prepData(marbidhour, type = "LL", coordNames = c("Longitude", "Latitude"))
plot(pmarbidhour, compact = T)
nrow(pmarbidhour)
#5670 points for Marbles before cleaning.

# South Bristols before cleaning
sbrsidhour <- rangeidhour1[rangeidhour1$MountainRange == "BrsS", ]
psbrsidhour <- prepData(sbrsidhour, type = "LL", coordNames = c("Longitude", "Latitude"))
plot(psbrsidhour, compact = T)
nrow(psbrsidhour)
# 7533 points for SBrs before cleaning.

#Nopah before cleaning
nopaidhour <- rangeidhour1[rangeidhour1$MountainRange == "Nopa", ]
pnopaidhour <- prepData(nopaidhour, type = "LL", coordNames = c("Longitude", "Latitude"))
plot(pnopaidhour, compact = T)
nrow(pnopaidhour)
#2655 points for Nopa before cleaning.

#Castle Piute before cleaning
cmpridhour <- rangeidhour1[rangeidhour1$MountainRange == "CMPR", ]
pcmpridhour <- prepData(cmpridhour, type = "LL", coordNames = c("Longitude", "Latitude"))
plot(pcmpridhour, compact = T)
nrow(pcmpridhour)
#1135 points for CMPR before cleaning.

# NROM before cleaning
nromidhour <- rangeidhour1[rangeidhour1$MountainRange == "NROM", ]
pnromidhour <- prepData(nromidhour, type = "LL", coordNames = c("Longitude", "Latitude"))
plot(pnromidhour, compact = T)
nrow(pnromidhour)
# 698 locations for NROM before cleaning.

```
Before looking at HDOP, I first deleted points considered to have location error based on their impossible elevation data (D'Eon et al. 2002). The range of elevations possible in each mountain range was calculated by drawing a polygon around each mountain range outside of CDFW's bighorn population range maps using Caltopo. All points outside of these possible range were eliminated.

Using CalTopo: 
Marbles: 597' - 3840' (181 m - 1171 m)
South Bristols: 703' - 3269' (214 m - 997 m)
NROM: 1800'-6095' (548 m - 1858 m)
Castle Piute: 4000'-5185' (1219 m - 1580 m)
Nopah: 1392'-5249' (424 m - 1599 m)

```{r}
# Marbles
boxplot(pmarbidhour$Altitude)
pmarbidhouralt <- pmarbidhour[(pmarbidhour$Altitude >= 181) & (pmarbidhour$Altitude <= 1171), ]
nrow(pmarbidhouralt)
# Marbles now have 5475 points, instead of 5670 points.
plot(pmarbidhouralt, compact = T)

# South Bristols
boxplot(psbrsidhour$Altitude)
psbrsidhouralt <- psbrsidhour[(psbrsidhour$Altitude >= 214) & (psbrsidhour$Altitude <= 997), ]
nrow(psbrsidhouralt)
# South Bristols now has 7196 points, before had 7533 points.
plot(psbrsidhouralt, compact = T)

#Nopah
boxplot(pnopaidhour$Altitude)
pnopaidhouralt <- pnopaidhour[(pnopaidhour$Altitude >= 424) & (pnopaidhour$Altitude <= 1599), ]
nrow(pnopaidhouralt)
# Nopah now has 2390 points, before had 2655 points.
plot(pnopaidhouralt, compact = T)

#Castle Piutes
boxplot(pcmpridhour$Altitude)
pcmpridhouralt <- pcmpridhour[(pcmpridhour$Altitude >= 1219) & (pcmpridhour$Altitude <= 1580), ]
nrow(pcmpridhouralt)
# Castle Piute now has 1075 points, before had 1135 points.
plot(pcmpridhouralt, compact = T)

# NROM
boxplot(pnromidhour$Altitude)
pnromidhouralt <- pnromidhour[(pnromidhour$Altitude >= 548) & (pnromidhour$Altitude <= 1858), ]
nrow(pnromidhouralt)
# NROM has 672 points, before had 698 points.
plot(pnromidhouralt, compact = T)
```

I then eliminated the points with a DOP above 10 (Lewis et al. 2007), as these points may not be spatially accurate due to minimum distribution of the satellites locating the collar.


```{r}
# Marbles
boxplot(pmarbidhouralt$DOP)
dopmarb <- pmarbidhouralt[pmarbidhouralt$DOP <= 10, ]
nrow(dopmarb)
# Marb now has 5420 points, before had 5475.
plot(dopmarb, compact = T)

# South Bristols
boxplot(psbrsidhouralt$DOP)
dopsbrs <- psbrsidhouralt[psbrsidhouralt$DOP <= 10, ]
nrow(dopsbrs)
# SBrs now has 7150 points, before had 7196.
plot(dopsbrs, compact = T)

# Nopah
boxplot(pnopaidhouralt$DOP)
dopnopa <- pnopaidhouralt[pnopaidhouralt$DOP <= 10, ]
nrow(dopnopa)
# Nopah now has 2371 points, before had 2390.
plot(dopnopa, compact = T)

# Castle Piute
boxplot(pcmpridhouralt$DOP)
dopcmpr <- pcmpridhouralt[pcmpridhouralt$DOP <= 10, ]
nrow(dopcmpr)
# Castle Piute now has 1065 points, before had 1075 points.
plot(dopcmpr, compact = T)

# NROM
boxplot(pnromidhouralt$DOP)
dopnrom <- pnromidhouralt[pnromidhouralt$DOP <= 10, ]
nrow(dopnrom)
# NROM now has 669 points, before had 672.
plot(dopnrom, compact = T)
```

I next examined the relative fix rate by mountain range to check for topographic bias. Since all analyses will be between comparable collars on the same fix schedule, I first separated the fixes back into 1 hour fix rate and 4 hour fix rate. I did subset the 1 hours fix rate collars to increase the 4 hour fix rate sample size. Sheep 1589 switched from 4 hour fix rate to 1 hour fix rate on 2019-06-15 16:00:00.

A lot of the basic, back-of-a-napkin calculations I did on a separate google sheet.


```{r}
dopall <- rbind(dopmarb, dopsbrs, dopcmpr, dopnopa, dopnrom)
# The points after BHS_1595 died are already eliminated from the dataset
# I went back and removed BHS_1692 from the dataset because he went over to East Ord for such a large percentage of the time and I am not confident in my absence of water sources in East Ord.

##Subsetting by sheep to differentiate between sheep with 4-hour collars and sheep with every-hour collars

# SBrs BHS_1580 2019-07-24 4:00 switches from 4 hour to 1 hour, holds steady on that until the end-- COULD INCLUDE IN 1 HOUR FIX Rate

# First differentiated between BHS_1589, BHS_1580 and all other sheep
just1589 <- dopall[dopall$ID == "BHS_1589", ]
dopall1 <- dopall[(dopall$ID != "BHS_1589") & (dopall$ID != "BHS_1580"), ]
just1589before <- just1589[just1589$DateTimeLocalTestct < as.POSIXct("2019-06-15 16:00:00"), ]
just1589after <- just1589[just1589$DateTimeLocalTestct >= as.POSIXct("2019-06-15 16:00:00"), ]
just1580 <- dopall[dopall$ID == "BHS_1580", ]
just1580before <- just1580[just1580$DateTimeLocalTestct < as.POSIXct("2019-07-24 04:00:00"), ]
just1580after <- just1580[just1580$DateTimeLocalTestct >= as.POSIXct("2019-07-24 04:00:00"), ]
# 1 hour fix rate
dopall2 <- dopall1[dopall1$ID == "BHS_1584" |  dopall1$ID == "BHS_1582" | dopall1$ID == "BHS_1577" | dopall1$ID == "BHS_1683" | dopall1$ID == "BHS_1682" | dopall1$ID == "BHS_1684" | dopall1$ID == "BHS_1688" | dopall1$ID == "BHS_1685" | dopall1$ID == "BHS_1689" | dopall1$ID == "BHS_1687" | dopall1$ID == "BHS_1686" | dopall1$ID == "BHS_1736" | dopall1$ID == "BHS_1740" | dopall1$ID == "BHS_1739" | dopall1$ID == "BHS_1730" | dopall1$ID == "BHS_1733", ]
cln1hrfix <- rbind(dopall2, just1589after, just1580after)
# 4 hour fix rate
dopall3 <- dopall1[dopall1$ID == "BHS_1581" | dopall1$ID == "BHS_1595" | dopall1$ID == "BHS_1588" | dopall1$ID == "BHS_1738" | dopall1$ID == "BHS_1568" | dopall1$ID == "BHS_1565" | dopall1$ID == "BHS_1567" | dopall1$ID == "BHS_1564" | dopall1$ID == "BHS_1677", ]
clan4hrfix <- rbind(dopall3, just1589before, just1580before)
# This only includes sheep that are set to 4 hours fix rate. But, can subset 1 hour fix rate to every four hours and include that too.
clan4hrfix1 <- subset(clan4hrfix, format(clan4hrfix$DateTimeLocalTest, "%H") %in% c('00', '04', '08', '12', '16', '20', '24'))
onetofour <- subset(cln1hrfix, format(cln1hrfix$DateTimeLocalTest, "%H") %in% c('00', '04', '08', '12', '16', '20', '24'))
clean4hrfixall <- rbind(clan4hrfix1, onetofour)

## Counting the difference between the actual number of observations and what number there should be if there is assuming a 100% fix rate and no deletion of points while data cleaning

# 1 hr fix rate

# Marbles: 
nrow(cln1hrfix[cln1hrfix$MountainRange == "Marb", ])
# There are 4758 fixes for Marb.
# Based on basic math I did in my google doc, there should be 6048 fixes for Marb.
# 4758/6048 = 78.67% fix rate

# South Bristols:
nrow(cln1hrfix[cln1hrfix$MountainRange == "BrsS", ])
# There are 6921 fixes for South Bristols.
# Based on basic math I did in my google doc, there should be 7676 fixes for SBrs.
# 6691/7320 = 90.16% fix rate

# Nopah
nrow(cln1hrfix[cln1hrfix$MountainRange == "Nopa", ])
# There are 2180 fixes for Nopah.
# There should be 2664 fixes.
# 2180/2664 = 81.83% fix rate

# CMPR
nrow(cln1hrfix[cln1hrfix$MountainRange == "CMPR", ])
# There are 1065 fixes for CMPR.
# There should be 1392 fixes. 
# 1065/1392 = 76.51% fix rate.

# All ranges together
nrow(cln1hrfix)
# Total Actual = 14924 fixes
# Total fixes there should be: 17780
# 14694/17424= 83.94% fix rate



# 4 hour fix rate

# Marbles
nrow(clean4hrfixall[clean4hrfixall$MountainRange == "Marb", ])
# There are 2067 fixes for the Marbles.
# Total fixes there should be: 2262
# 2067/2262 = 91.38% fix rate

# South Bristols
nrow(clean4hrfixall[clean4hrfixall$MountainRange == "BrsS", ])
# There are 1964 fixes for the South Bristols.
# Total fixes there should be: 2196
# 2137/2196 = 89.44%

# Nopah
nrow(clean4hrfixall[clean4hrfixall$MountainRange == "Nopa", ])
# There are 795 for the Nopahs.
# Total fixes there should be: 888
# 795/888 = 89.53% fix rate

# CMPR
nrow(clean4hrfixall[clean4hrfixall$MountainRange == "CMPR", ])
# 325 points for CMPR.
# Total fixes there should be: 348
# 93.34% fix rate

# NROM
nrow(clean4hrfixall[clean4hrfixall$MountainRange == "NROM", ])
# 533 points for NROM.
# Total fixes there should be: 570
# 93.51% fix rate

# All mtn ranges together except NROM:
nrow(clean4hrfixall[clean4hrfixall$MountainRange == "Marb" | clean4hrfixall$MountainRange == "BrsS" | clean4hrfixall$MountainRange == "Nopa" | clean4hrfixall$MountainRange == "CMPR",])
# 5151 points for Marb, BrsS, Nopa, CMPR.
# Total fixes there should be: 5694
# 5151/5694 = 90.46% fix rate

# All mtn ranges together including NROM:
nrow(clean4hrfixall)
# 5684 points total
# Total fixes there should be: 6264
# 5684/6264 = 90.74% fix rate
```
I then started to calculate my four measures of GPS movement: step length, turning angle, distance to water, angle of movement relative to water. I decided to start with 1 hr, then do 4 hr. To start with, I calculated turning angle.

- if turning angle is different between different sheep- DONE
- if turning angle is different by month- DONE
- if turning angle is different by mountain range - DONE
- if turning angle is different by time-of-day

```{r}
library(moveHMM)
# 1 hr fix
names(cln1hrfix)[names(cln1hrfix) == "y"] <- "Latitude"
names(cln1hrfix)[names(cln1hrfix) == "x"] <- "Longitude"
cln1hrfix1 <- cln1hrfix[with(cln1hrfix, order(ID, DateTimeLocalTestct)), ]
cln1hrfix1$TimeLocal <- format(cln1hrfix1$DateTimeLocalTestct, format = "%H:%M")
pcln1hrfix <- prepData(cln1hrfix1, type = "LL", coordNames = c("Longitude", "Latitude"))
# Upon examination, these turning angles are in radians. The min and max are pi, which makes sense because it is impossible to have a turning angle greater than 180 degrees since the angle that the animal turned should be assumed to be the smaller one (why would I turn 270 degrees when I can only turn 90?). Since for this metric, all I am looking at is the tortuosity of the track, I think I should make every radian angle positive. After all, I do not care about whether the sheep turned left or right.
pcln1hrfix$positangle <- abs(pcln1hrfix$angle)
library(amt)
pcln1hrfix$positangledegree <- as_degree(pcln1hrfix$positangle)
# Angles between sheep are already deleted because of how prepData function worked
# Need to make sure that points before and after a given point were actually taken an hour before and an hour after.
pcln1hrfix$lagtime <- (pcln1hrfix$DateTimeLocalTestct - lag(pcln1hrfix$DateTimeLocalTestct))
pcln1hrfix$leadtime <- (lead(pcln1hrfix$DateTimeLocalTestct) - pcln1hrfix$DateTimeLocalTestct)
pcln1hrfix$lagtime <- as.numeric(pcln1hrfix$lagtime)
pcln1hrfix$leadtime <- as.numeric(pcln1hrfix$leadtime)
pcln1hrfix1 <- pcln1hrfix[((pcln1hrfix$lagtime >= 50 & pcln1hrfix$lagtime <= 70) & (pcln1hrfix$leadtime >= 50 & pcln1hrfix$leadtime <= 70)), ]



hist(pcln1hrfix1$positangledegree, xlab = "Angle Degree", main = "Frequency of Turning Angles at 1 Hr Fix Rate for All Bighorn (n = 12964)")
pcln1hrfix1$Month <- month(pcln1hrfix1$DateTimeLocalTestct)
pcln1hrfix1$MountainRange <- droplevels(pcln1hrfix1$MountainRange)
# If turning angle is different by mountain range
boxplot(positangledegree ~ MountainRange, data = pcln1hrfix1, ylab = "Turning Angle", main = "Turning Angle by Mountain Range")
turnangleMtnRange <- aov(positangledegree ~ MountainRange, data = pcln1hrfix1)
summary.lm(turnangleMtnRange)
# Multiple R-squared:  0.0003166, Adjusted R-squared:  8.509e-05
# F-statistic: 1.368 on 3 and 12955 DF,  p-value: 0.2506
TukeyHSD(turnangleMtnRange)
#                 diff       lwr      upr     p adj
# CMPR-BrsS  1.7289660 -3.340182 6.798114 0.8171345
# Marb-BrsS -1.7841234 -4.683856 1.115610 0.3895996
# Nopa-BrsS -0.6429978 -4.457247 3.171252 0.9727806
# Marb-CMPR -3.5130893 -8.759514 1.733336 0.3129495
# Nopa-CMPR -2.3719637 -8.174120 3.430193 0.7196964
# Nopa-Marb  1.1411256 -2.905751 5.188002 0.8873445
# Turning angle is not significantly different between any mountain ranges.

# If turning angle is significantly different by individual sheep
boxplot(positangledegree ~ ID, data = pcln1hrfix1, ylab = "Turning Angle", main = "Turning Angle by Individual Bighorn")
turnangleid <- aov(positangledegree ~ ID, data = pcln1hrfix1)
summary.lm(turnangleid)
# Multiple R-squared:  0.00476, Adjusted R-squared:  0.003453
# F-statistic: 3.641 on 17 and 12941 DF,  p-value: 5.313e-07
TukeyHSD(turnangleid)
# Only bighorn combos that were significantly different were: 1686-1584, 1686-1682, 1687-1686, 1688-1686, 1740-1686, 1740-1739.

# If turning angle is different by month
# Because there was no significant difference between mountain ranges, I did not divide up these results by mountain range.
boxplot(positangledegree ~ Month, data = pcln1hrfix1, main = "Turn Angle by Month")
pcln1hrfix1$Month <- as.factor(pcln1hrfix1$Month)
turnanglemonth <- aov(positangledegree ~ Month, data = pcln1hrfix1)
summary.lm(turnanglemonth)
# Multiple R-squared:  0.0009122, Adjusted R-squared:  0.0006808
# F-statistic: 3.943 on 3 and 12955 DF,  p-value: 0.008015
TukeyHSD(turnanglemonth)
#           diff        lwr        upr     p adj
# 6-5 -2.3332716  -9.200252  4.5337086 0.8188386
# 7-5 -5.5160170 -12.346045  1.3140114 0.1613233
# 8-5 -5.2894958 -12.395589  1.8165977 0.2227202
# 7-6 -3.1827453  -6.071774 -0.2937171 0.0240622
# 8-6 -2.9562242  -6.448181  0.5357326 0.1302038
# 8-7  0.2265211  -3.192197  3.6452390 0.9982468
# There was only a significant different in turning angle between June and July. The fact that there wasn't a significant between farther apart months brings into question the relevance of this significance.

```

I next calculated the shortest topographic distance between points. This is basically step length, accounting for elevation.

```{r}

#Nopah

# Setting up the elevation raster
library(raster)
library(sp)
library(rgdal)
# nopahelevation <- raster("C:/Users/Danielle Glass/Downloads/nopahelevation.tif")
# proj4string(nopahelevation) <- CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs")
# plot(nopahelevation, compact = TRUE)
library(rgdal)
# tnopahelevation <- projectRaster(from = nopahelevation, crs = ("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
# plot(tnopahelevation)
# nopahelevationattempt2 <- raster("C:/Users/Danielle Glass/Downloads/NopahElevation1.tif")
# proj4string(nopahelevationattempt2) <- CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs")

nopahelevationattempt3 <- raster("C:/Users/dmg85/Downloads/Sheepies3-master/output_srtm.tif")
#
# Attempt below didn't work, but one above did?
# nopahelevationproj <- projectRaster(nopahelevation, crs = "+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs")

# WGS 84

# Setting up the SpatialPointsObjects
onehrnopah <- pcln1hrfix[pcln1hrfix$MountainRange == "Nopa", ]
onehrnopah$ID <- droplevels(onehrnopah$ID)
coordsnopa <- as.data.frame(onehrnopah[ ,c("x", "y")])
restodatanopa <- as.data.frame(onehrnopah[ , c(1:3, 6:28)])
crsnopa <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
# crsnopa <- CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs")
nopaspdf <- SpatialPointsDataFrame(coords = coordsnopa, data = restodatanopa, proj4string = crsnopa)
# tnopaspdf <- spTransform(nopaspdf , CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs"))
# jpeg("tnopaspdf.jpg", width = 8, height = 12, units = "in", res = 180)
# plot(tnopaspdf)
# dev.off()
# View(nopaspdf@data)

library(topoDistance)
topodistnopa <- topoDist(DEM = nopahelevationattempt3, pts = nopaspdf, directions = 8, paths = FALSE, zweight = 1)
View(topodistnopa)
topodistnopa1 <- as.matrix(topodistnopa)
topodistnopa1sub <- topodistnopa1[row(topodistnopa1) == (col(topodistnopa1) - 1)]
View(topodistnopa1sub)
natopodistnopa1sub <- c(NA, topodistnopa1sub)

onehrnopah2 <- cbind(onehrnopah, natopodistnopa1sub)
# Then deleted the wrong distances that were calculated between sheep.
onehrnopah2 <- cbind(rownames(onehrnopah2), data.frame(onehrnopah2, row.names = NULL))
onehrnopah2[685, 30] <- NA
onehrnopah2[1389, 30] <- NA

# Castle Piute

castlepiuteelevation <- raster("C:/Users/dmg85/Downloads/Sheepies3-master/castlepiuteelevation.tif")
onehrcmpr <- pcln1hrfix[pcln1hrfix$MountainRange == "CMPR",]
onehrcmpr$ID <- droplevels(onehrcmpr$ID)
coordscmpr <- as.data.frame(onehrcmpr[ ,c("x", "y")])
restodatacmpr <- as.data.frame(onehrcmpr[ , c(1:3, 6:28)])
crscmpr <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
cmprspdf <- SpatialPointsDataFrame(coords = coordscmpr, data = restodatacmpr, proj4string = crscmpr)
topodistcmpr <- topoDist(DEM = castlepiuteelevation, pts = cmprspdf, directions = 8, paths = FALSE, zweight = 1)
topodistcmpr1 <- as.matrix(topodistcmpr)
topodistcmpr1sub <- topodistcmpr1[row(topodistcmpr1) == (col(topodistcmpr1) - 1)]
# View(topodistcmpr1sub)
natopodistcmpr1sub <- c(NA, topodistcmpr1sub)
onehrcmpr2 <- cbind(onehrcmpr, natopodistcmpr1sub)
onehrcmpr2 <- cbind(rownames(onehrcmpr2), data.frame(onehrcmpr2, row.names = NULL))
onehrcmpr2[546, 30] <- NA

# Marbles
marbleselevation <- raster("C:/Users/dmg85/Downloads/Sheepies3-master/marbleselevation.tif")
onehrmarb <- pcln1hrfix[pcln1hrfix$MountainRange == "Marb", ]
onehrmarb$ID <- droplevels(onehrmarb$ID)
coordsmarb <- as.data.frame(onehrmarb[ , c("x", "y")])
restodatamarb <- as.data.frame(onehrmarb[ , c(1:3, 6:28)])
crsmarb <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
marbspdf <- SpatialPointsDataFrame(coords = coordsmarb, data = restodatamarb, proj4string = crsmarb)
topodistmarb <- topoDist(DEM = marbleselevation, pts = marbspdf, directions = 8, paths = FALSE, zweight = 1)
topodistmarb1 <- as.matrix(topodistmarb)
topodistmarb1sub <- topodistmarb1[row(topodistmarb1) == (col(topodistmarb1) - 1)]
# View(topodistmarb1sub)
natopodistmarb1sub <- c(NA, topodistmarb1sub)
onehrmarb2 <- cbind(onehrmarb, natopodistmarb1sub)
onehrmarb2 <- cbind(rownames(onehrmarb2), data.frame(onehrmarb2, row.names = NULL))
onehrmarb2[511, 30] <- NA
onehrmarb2[1108, 30] <- NA
onehrmarb2[1707, 30] <- NA
onehrmarb2[2201, 30] <- NA
onehrmarb2[3086, 30] <- NA
onehrmarb2[3949, 30] <- NA

# South Bristols
sbrselevation <- raster("C:/Users/dmg85/Downloads/Sheepies3-master/sbristolselevation.tif")
onehrsbrs <- pcln1hrfix[pcln1hrfix$MountainRange == "BrsS", ]
onehrsbrs$ID <- droplevels(onehrsbrs$ID)
coordsbrs <- as.data.frame(onehrsbrs[ , c("x", "y")])
restodatasbrs <- as.data.frame(onehrsbrs[ , c(1:3, 6:28)])
crsbrs <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
sbrspdf <- SpatialPointsDataFrame(coords = coordsbrs, data = restodatasbrs, proj4string = crsbrs)
topodistsbrs <- topoDist(DEM = sbrselevation, pts = sbrspdf, directions = 8, paths = FALSE, zweight = 1)
topodistsbrs1 <- as.matrix(topodistsbrs)
topodistsbrs1sub <- topodistsbrs1[row(topodistsbrs1) == (col(topodistsbrs1) - 1)]
# View(topodistsbrs1sub)
natopodistsbrs1sub <- c(NA, topodistsbrs1sub)
onehrsbrs2 <- cbind(onehrsbrs, natopodistsbrs1sub)
onehrsbrs2 <- cbind(rownames(onehrsbrs2), data.frame(onehrsbrs2, row.names = NULL))
onehrsbrs2[231, 30] <- NA
onehrsbrs2[1579, 30] <- NA
onehrsbrs2[2990, 30] <- NA
onehrsbrs2[4322, 30] <- NA
onehrsbrs2[5692, 30] <- NA

# Need the row names to be the same in order to rbind to work
names(onehrnopah2)[names(onehrnopah2) == "rownames(onehrnopah2)"] <- "rownumlrgdatset"
names(onehrcmpr2)[names(onehrcmpr2) == "rownames(onehrcmpr2)"] <- "rownumlrgdatset"
names(onehrmarb2)[names(onehrmarb2) == "rownames(onehrmarb2)"] <- "rownumlrgdatset"
names(onehrsbrs2)[names(onehrsbrs2) == "rownames(onehrsbrs2)"] <- "rownumlrgdatset"

names(onehrnopah2)[names(onehrnopah2) == "natopodistnopa1sub"] <- "stplengthtopo"
names(onehrcmpr2)[names(onehrcmpr2) == "natopodistcmpr1sub"] <- "stplengthtopo"
names(onehrmarb2)[names(onehrmarb2) == "natopodistmarb1sub"] <- "stplengthtopo"
names(onehrsbrs2)[names(onehrsbrs2) == "natopodistsbrs1sub"] <- "stplengthtopo"
steplengthallmtn <- rbind(onehrnopah2, onehrcmpr2, onehrmarb2, onehrsbrs2)


# library(dplyr)
# BrsSlongtimedif <- BrsScutobslong %>%
#   arrange(KI_Known_ID, DateTimect) %>%
#   group_by(KI_Known_ID) %>%
#   mutate(Timediff = DateTimect - lag(DateTimect), diff_hours = as.numeric(Timediff, units = 'hours'))

# library(adehabitatLT)
# data.lt.nopah <- as.ltraj(xy = onehrnopah[, c("x", "y")], date = onehrnopah$DateTimeLocalTestct, id = onehrnopah$ID)
# View(data.lt.nopah[[1]])

# data.lt_Desert <- as.ltraj(xy = DesertDataDanielleNoDuplicates[, c("UTME", "UTMN")], date = DesertDataDanielleNoDuplicates$DateTimeC, id = DesertDataDanielleNoDuplicates$ID)

# data.lt<-as.ltraj(xy=data[,c("x","y")], date=data$date, id=data$id)





```

I conducted the preliminary analyses related to step length. I read in the data at the beginning because I had to conduct the previous chunk on a computer more powerful than my laptop. All topographic step lengths are in meters.

- step length different by mountain range - DONE
- different by individual sheep - 
- different by month
- different by time of day

```{r}
steplengthallmtn <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/steplengthallmtn3820.csv")
# Need to make sure that points before and after a given point were actually taken an hour before and an hour after.
library(lubridate)
steplengthallmtn$DateTimeLocalTestct <- as.character(steplengthallmtn$DateTimeLocalTestct)
steplengthallmtn$DateTimeLocalTestct <- strptime(steplengthallmtn$DateTimeLocalTestct, "%m/%d/%Y %H:%M")
steplengthallmtn$DateTimeLocalTestct <- as.POSIXct(steplengthallmtn$DateTimeLocalTestct, tz = "America/Los_Angeles", format = "%m/%d/%Y% %H:%M")
steplengthallmtn$lagtime <- (steplengthallmtn$DateTimeLocalTestct - lag(steplengthallmtn$DateTimeLocalTestct))
steplengthallmtn$leadtime <- (lead(steplengthallmtn$DateTimeLocalTestct) - steplengthallmtn$DateTimeLocalTestct)
steplengthallmtn$lagtime <- as.numeric(steplengthallmtn$lagtime)
steplengthallmtn$leadtime <- as.numeric(steplengthallmtn$leadtime)
steplengthallmtn1 <- steplengthallmtn[((steplengthallmtn$lagtime >= 50 & steplengthallmtn$lagtime <= 70) & (steplengthallmtn$leadtime >= 50 & steplengthallmtn$leadtime <= 70)), ]

# Step length different by mountain range
# The following hist does not include all step lengths, there are a couple in the thousands, max = ~8000 meters.
hist(steplengthallmtn1$stplengthtopo, breaks = 80, xlim = c(0, 1500), xlab = "Step Length (m)", main = "Frequency of Step Length Given All Bighorn")
boxplot(stplengthtopo ~ MountainRange, data = steplengthallmtn1, xlab = "Mountain Range", ylab = "Distanced Moved Per Hour", main = "Distance Moved Per Hour by Mountain Range")
stplengthmtnrange <- aov(stplengthtopo ~ MountainRange, data = steplengthallmtn1)
summary.lm(stplengthmtnrange)
# Multiple R-squared:  0.002887,	Adjusted R-squared:  0.002656 
# F-statistic: 12.51 on 3 and 12959 DF,  p-value: 3.672e-08
TukeyHSD(stplengthmtnrange)
#                  diff        lwr        upr     p adj
# CMPR-BrsS -30.1553276 -50.908246  -9.402409 0.0010878
# Marb-BrsS  -1.7340688 -13.603169  10.135031 0.9819728
# Nopa-BrsS -30.9629630 -46.578123 -15.347803 0.0000021
# Marb-CMPR  28.4212588   6.943132  49.899386 0.0037746
# Nopa-CMPR  -0.8076354 -24.561954  22.946683 0.9997612
# Nopa-Marb -29.2288942 -45.795714 -12.662074 0.0000347
# There is a significant difference in step length by mountain range. This clearly differentiates the 'low, hot' mountain ranges from the 'high, cool' mountain ranges.

# Whether step length is different by individual bighorn
boxplot(stplengthtopo ~ ID, data = steplengthallmtn1, ylab = "Distance Traveled/Hr", main = "Distance Traveled Per Hour for a Given Bighorn")
steplengthid <- aov(stplengthtopo ~ ID, data = steplengthallmtn1)
summary.lm(steplengthid)
# Multiple R-squared:  0.01733,	Adjusted R-squared:  0.01604 
# F-statistic: 13.43 on 17 and 12945 DF,  p-value: < 2.2e-16
TukeyHSD(steplengthid)
# Out of 120, 48 combinations of two sheep were significantly different.

#Whether step length is different by month
# Because step length was different by mountain range, I am analyzing this by mountain range.
steplengthallmtn1$Month <- as.factor(steplengthallmtn1$Month)
marbsl <- steplengthallmtn1[steplengthallmtn1$MountainRange == "Marb", ]
sbrssl <- steplengthallmtn1[steplengthallmtn1$MountainRange == "BrsS", ]
cmprsl <- steplengthallmtn1[steplengthallmtn1$MountainRange == "CMPR", ]
nopasl <- steplengthallmtn1[steplengthallmtn1$MountainRange == "Nopa", ]
# Marbles
boxplot(stplengthtopo ~ Month, data = marbsl, ylab = "Distance Traveled/Hr", main = "Marbles")
slmarbmonth <- aov(stplengthtopo ~ Month, data = marbsl)
summary.lm(slmarbmonth)
# Multiple R-squared:  0.001935,	Adjusted R-squared:  0.001186 
# F-statistic: 2.584 on 3 and 3999 DF,  p-value: 0.05157
TukeyHSD(slmarbmonth)
# Only June and August are significantly different (p = 0.0455908)
# South Bristols
boxplot(stplengthtopo ~ Month, data = sbrssl, ylab = "Distance Traveled/Hr", main = "South Bristols")
slsbrsmonth <- aov(stplengthtopo ~ Month, data = sbrssl)
summary.lm(slsbrsmonth)
# Multiple R-squared:  0.01952,	Adjusted R-squared:  0.0192 
# F-statistic: 61.94 on 2 and 6224 DF,  p-value: < 2.2e-16
TukeyHSD(slsbrsmonth)
#          diff       lwr        upr     p adj
# 7-6  75.82240  59.63903 92.0057627 0.0000000
# 8-6  54.51713  33.57619 75.4580655 0.0000000
# 8-7 -21.30527 -41.93470 -0.6758308 0.0410484
# All months are significantly different from each other in the South Bristols.
# Nopah
boxplot(stplengthtopo ~ Month, data = nopasl, ylab = "Distance Traveled/Hr", main = "Nopah")
slnopamonth <- aov(stplengthtopo ~ Month, data = nopasl)
summary.lm(slnopamonth)
# Multiple R-squared:  0.001923,	Adjusted R-squared:  0.0008235 
# F-statistic: 1.749 on 2 and 1816 DF,  p-value: 0.1742
TukeyHSD(slnopamonth)
#          diff        lwr      upr     p adj
# 7-6 14.793955  -7.513511 37.10142 0.2653926
# 8-6 21.115762  -7.278934 49.51046 0.1890717
# 8-7  6.321807 -17.660435 30.30405 0.8101085
# No months are significantly different from each other in the Nopahs.
# Castle Piute
boxplot(stplengthtopo ~ Month, data = cmprsl, ylab = "Distance Traveled/Hr", main = "Castle Piute")
slcmprmonth <- aov(stplengthtopo ~ Month, data = cmprsl)
summary.lm(slcmprmonth)
# Multiple R-squared:  0.006777,	Adjusted R-squared:  0.004597 
# F-statistic: 3.108 on 2 and 911 DF,  p-value: 0.04516
TukeyHSD(slcmprmonth)
#          diff        lwr      upr     p adj
# 7-6 34.067966  -7.128176 75.26411 0.1277739
# 8-6 29.276394  -0.455967 59.00876 0.0547090
# 8-7 -4.791572 -42.058157 32.47501 0.9510234
# Only June was different from August.




```
I then calculated the distance to water relative to the closest water source.


```{r}
#Nopah

# Setting up the elevation raster
library(raster)
library(sp)
library(rgdal)
nopahelevation4 <- raster("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/output_srtmNopahElevation4520.tif")
# Merging gps data and Nopah water sources data 
steplengthallmtn1$WaterSource <- NA
NopahWater <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/NopahWaterSources.csv")
nopaallmtn1 <- steplengthallmtn1[steplengthallmtn1$MountainRange == "Nopa",]
nopawatergps <- rbind(NopahWater, nopaallmtn1)
# View(nopawatergps)
nopawatergps1 <- nopawatergps[-c(4, 5, 6, 7, 1827),]
#Setting up the SpatialPointsObjects
nopawatergps1$BHSID <- as.factor(nopawatergps1$BHSID)
nopacoords <- as.data.frame(nopawatergps1[ ,c("x", "y")])
noparestodata <- as.data.frame(nopawatergps1[ ,c(1:5, 8:34)])
# crsnopa is already the coordinate system
spdfnopa <- SpatialPointsDataFrame(coords = nopacoords, data = noparestodata, proj4string = crsnopa)
library(topoDistance)
nopatopodist <- topoDist(DEM = nopahelevation4, pts = spdfnopa, directions = 8, paths = FALSE, zweight = 1)
# Extract just distances that are between the points and the water sources
nopatopodist1  <- nopatopodist[, c(1:3)]
# Changing to a dataframe
nopatopodist1 <- as.data.frame(nopatopodist1)
# Changing the column names to the water sources they correspond to
names(nopatopodist1)[names(nopatopodist1) == "1"] <- "ElSi"
names(nopatopodist1)[names(nopatopodist1) == "2"] <- "Nopa"
names(nopatopodist1)[names(nopatopodist1) == "3"] <- "SNop"
# Making column which names which water source the point is closest to
nopatopodist1$WhichClose <- colnames(nopatopodist1)[apply(nopatopodist1, 1, which.min)]
# Making column of the distance to the closest water source
nopatopodist1$Closedist <- pmin(nopatopodist1$ElSi, nopatopodist1$Nopa, nopatopodist1$SNop)
# Making the necessary changes to add the close dist and which close columns to the original Nopah dataframe
nopaallmtn2 <- nopaallmtn1[-c(1820), ]
nopatopodist2 <- nopatopodist1[-c(1, 2, 3), ]
nopaallmtnwdistwater <- cbind(nopaallmtn2, nopatopodist2[, 4:5, drop = FALSE])
# To calculate the angle of movement relative to water
# nopaallmtnwdistwater$angletowater <- acos((((lag(nopaallmtnwdistwater$Closedist))^2) - ((nopaallmtnwdistwater$stplengthtopo)^2) - ((nopaallmtnwdistwater$Closedist)^2)) / (-2 * (nopaallmtnwdistwater$stplengthtopo) * (nopaallmtnwdistwater$Closedist)))
# library(amt)
# nopaallmtnwdistwater$atowdeg <- as_degree(nopaallmtnwdistwater$angletowater)
# THIS IS WRONG - HELP!!!

# Castle Piute
elevationcmpr <- raster("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/castlepiuteelevation.tif")
cmprwatersources <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/cmprwatersources.csv")
cmprallmtn1 <- steplengthallmtn1[steplengthallmtn1$MountainRange == "CMPR",]
cmprwatergps <- rbind(cmprwatersources, cmprallmtn1)
View(cmprwatergps)
cmprwatergps1 <- cmprwatergps[-c(917), ]
# Setting up the Spatial Points Object
cmprwatergps1$BHSID <- as.factor(cmprwatergps1$BHSID)
cmprcoords <- as.data.frame(cmprwatergps1[ ,c("x", "y")])
cmprrestodata <- as.data.frame(cmprwatergps1[ ,c(1:5, 8:34)])
# crscmpr is already the coordinate system
spdfcmprwater <- SpatialPointsDataFrame(coords = cmprcoords, data = cmprrestodata, proj4string = crscmpr)
cmprtopodistwater <- topoDist(DEM = elevationcmpr, pts = spdfcmprwater, directions = 8, paths = FALSE, zweight = 1)
# Extract just distances that are between the points and the water sources
cmprtopodistwater1 <- cmprtopodistwater[, c(1:2)]
# Changing to a dataframe
cmprtopodistwater1 <- as.data.frame(cmprtopodistwater1)
# Changing the column names to the water sources they correspond to
names(cmprtopodistwater1)[names(cmprtopodistwater1) == "1"] <- "Vice"
names(cmprtopodistwater1)[names(cmprtopodistwater1) == "2"] <- "KidS"
# Making column which names which water source the point is closest to
cmprtopodistwater1$WhichClose <- colnames(cmprtopodistwater1)[apply(cmprtopodistwater1, 1, which.min)]
# Making column of the distance to the closest water source
cmprtopodistwater1$Closedist <- pmin(cmprtopodistwater1$Vice, cmprtopodistwater1$KidS)
# Making the necessary changes to add the close dist and which close columns to the original Nopah dataframe
cmprallmtn2 <- cmprallmtn1[-c(915), ]
cmprtopodistwater2 <- cmprtopodistwater1[-c(1, 2), ]
cmprallmtnwdistwater <- cbind(cmprallmtn2, cmprtopodistwater2[, 3:4, drop = FALSE])
# To calculate the angle of movement relative to water
# cmprallmtnwdistwater$angletowater <- acos((((lag(cmprallmtnwdistwater$Closedist))^2) - ((cmprallmtnwdistwater$stplengthtopo)^2) - ((cmprallmtnwdistwater$Closedist)^2)) / (-2 * (cmprallmtnwdistwater$stplengthtopo) * (cmprallmtnwdistwater$Closedist)))
# library(amt)
# cmprallmtnwdistwater$atowdeg <- as_degree(cmprallmtnwdistwater$angletowater)
# THIS IS STILL WRONG - FIX!!!

# Marbles
# steplengthallmtn1 <- read.csv("steplengthallmtn1.csv")
marbanotherelevation <- raster("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/Marbelevation41920.tif")
elevationmarbbrsS <- raster("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/MarbBrsSelevation.tif")
Marbwater529andbefore <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/Marb529andBeforeWaterSources.csv")
Marbwater530andafter <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/Marb530afterWaterSources.csv")
marballmtn1 <- steplengthallmtn1[steplengthallmtn1$MountainRange == "Marb",]
marballmtn2 <- marballmtn1[, -c(35)]
# as.POSIXct
marballmtn529before <- marballmtn2[marballmtn2$DateTimeLocalTestct <= as.Date("2019-05-29 23:59:59"), ]
marballmtn529before1 <- marballmtn529before[, -c(35)]
marballmtn530after <- marballmtn2[marballmtn2$DateTimeLocalTestct >= as.Date("2019-05-30 00:00:00"), ]
# For 5/29 and before
marbwatergpsbefore <- rbind(Marbwater529andbefore, marballmtn529before1)
marbwatergpsbefore1 <- marbwatergpsbefore[-c(6:12, 494), ]
marbwatergpsbefore1$BHSID <- as.factor(marbwatergpsbefore1$BHSID)
marbbeforecoords <- as.data.frame(marbwatergpsbefore1[ ,c("x", "y")])
marbbeforerestodata <- as.data.frame(marbwatergpsbefore1[ ,c(1:5, 8:34)])
# crs marb is already the coordinate system
# crsmarb <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
spdfmarbbefore <- SpatialPointsDataFrame(coords = marbbeforecoords, data = marbbeforerestodata, proj4string = crsmarb)
library(topoDistance)
# memory.limit(size = 8000)
marbbeforetopodist <- topoDist(DEM = marbanotherelevation, pts = spdfmarbbefore, directions = 8, paths = FALSE, zweight = 1)
marbbeforetopodist1 <- marbbeforetopodist[, c(1:5)]
marbbeforetopodist1 <- as.data.frame(marbbeforetopodist1)
names(marbbeforetopodist1)[names(marbbeforetopodist1) == "1"] <- "SMar"
names(marbbeforetopodist1)[names(marbbeforetopodist1) == "2"] <- "SI40"
names(marbbeforetopodist1)[names(marbbeforetopodist1) == "3"] <- "Ther"
names(marbbeforetopodist1)[names(marbbeforetopodist1) == "4"] <- "Vern"
names(marbbeforetopodist1)[names(marbbeforetopodist1) == "5"] <- "DevS"
marbbeforetopodist1$WhichClose <- colnames(marbbeforetopodist1)[apply(marbbeforetopodist1, 1, which.min)]
marbbeforetopodist1$Closedist <- pmin(marbbeforetopodist1$SMar, marbbeforetopodist1$SI40, marbbeforetopodist1$Ther, marbbeforetopodist1$Vern, marbbeforetopodist1$DevS)
marbbeforetopodist2 <- marbbeforetopodist1[-c(1, 2, 3, 4, 5), ]
# 5/30 and after
marballmtn530after1 <- marballmtn530after[, -c(35)]
marbwatergpsafter <- rbind(Marbwater530andafter, marballmtn530after1)
marbwatergpsafter1 <- marbwatergpsafter[-c(3527), ]
marbwatergpsafter1$BHSID <- as.factor(marbwatergpsafter1$BHSID)
marbaftercoords <- as.data.frame(marbwatergpsafter1[ ,c("x", "y")])
marbafterrestofdata <- as.data.frame(marbwatergpsafter1[ c(1:5, 8:34)])
#crsmarb already the coordinate system
spdfmarbafter <- SpatialPointsDataFrame(coords = marbaftercoords, data = marbafterrestofdata, proj4string = crsmarb)
library(topoDistance)
marbaftertopodist <- topoDist(DEM = marbanotherelevation, pts = spdfmarbafter, directions = 8, paths = FALSE, zweight = 1)
marbaftertopodist1 <- marbaftertopodist[, c(1:4)]
marbaftertopodist1 <- as.data.frame(marbaftertopodist1)
names(marbaftertopodist1)[names(marbaftertopodist1) == "1"] <- "SI40"
names(marbaftertopodist1)[names(marbaftertopodist1) == "2"] <- "Ther"
names(marbaftertopodist1)[names(marbaftertopodist1) == "3"] <- "Vern"
names(marbaftertopodist1)[names(marbaftertopodist1) == "4"] <- "DevS"
marbaftertopodist1$WhichClose <- colnames(marbaftertopodist1)[apply(marbaftertopodist1, 1, which.min)]
marbaftertopodist1$Closedist <- pmin(marbaftertopodist1$SI40, marbaftertopodist1$Ther, marbaftertopodist1$Vern, marbaftertopodist1$DevS)
marbaftertopodist2 <- marbaftertopodist1[-c(1, 2, 3, 4), ]
# Putting everything together INCORRECTLY
# marballmtn3 <- marballmtn2[-c(4004), ]
# marbaftertopodist3 <- cbind(SMar = NA, marbaftertopodist2)
# marballtopodist <- rbind(marbbeforetopodist2, marbaftertopodist3)
# marballmtndistwater <- cbind(marballmtn3, marballtopodist[, 6:7, drop = FALSE])
# Putting everything together correctly (hopefully)
# Adding before 5/29 to that data
marballmtn529before2 <- marballmtn529before1[-c(482), ]
marbbefore529distwater <- cbind(marballmtn529before2, marbbeforetopodist2[, 6:7, drop = FALSE])
#Adding 5/30 and after to that data
marballmtn530after2 <- marballmtn530after1[-c(3523), ]
marbafter530distwater <- cbind(marballmtn530after2, marbaftertopodist2[, 5:6, drop = FALSE])
# Combining the two time chunks
marballmtndistwater <- rbind(marbbefore529distwater, marbafter530distwater)

# South Bristols
# sbrselevation <- raster("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/SBRSelevation42220.tif")
sbrselevation <- raster("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/SBrselevationattempt4.tif")
SBrs2water <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/BrsSonlytwowatersources.csv")
SBrs3water <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/BrsSallthreewatersources.csv")
sbrsallmtn1 <- steplengthallmtn1[steplengthallmtn1$MountainRange == "BrsS", ]
sbrsallmtn2 <- sbrsallmtn1[-c(6228), -c(35, 36)]
sbrsallmtn722andbefore <- sbrsallmtn2[sbrsallmtn2$DateTimeLocalTestct <= as.POSIXct("2019-07-22 23:59:59"), ]
sbrsallmtn72324 <- sbrsallmtn2[((sbrsallmtn2$DateTimeLocalTestct >= as.POSIXct("2019-07-23 00:00:00")) & (sbrsallmtn2$DateTimeLocalTestct <= as.POSIXct("2019-07-24 23:59:59"))), ]
sbrsallmtn725aafter <- sbrsallmtn2[sbrsallmtn2$DateTimeLocalTestct >= as.POSIXct("2019-07-25 00:00:00"), ]
# For 7/22 and before
sbrswatergps722abefore <- rbind(SBrs3water, sbrsallmtn722andbefore)
sbrswatergps722abefore$BHSID <- as.factor(sbrswatergps722abefore$BHSID)
sbrsbefore722coords <- as.data.frame(sbrswatergps722abefore[ ,c("x", "y")])
sbrsbefore722restodata <- as.data.frame(sbrswatergps722abefore[ ,c(1:5, 8:34)])
crssbrs <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
spdfsbrsbefore722 <- SpatialPointsDataFrame(coords = sbrsbefore722coords, data = sbrsbefore722restodata, proj4string = crssbrs)
library(topoDistance)
sbrsbefore722topodist <- topoDist(DEM = sbrselevation, pts = spdfsbrsbefore722, directions = 8, paths = FALSE, zweight = 1)
sbrsbefore722topodist1 <- sbrsbefore722topodist[, c(1:3)]
sbrsbefore722topodist1 <- as.data.frame(sbrsbefore722topodist1)
names(sbrsbefore722topodist1)[names(sbrsbefore722topodist1) == "1"] <- "MilC"
names(sbrsbefore722topodist1)[names(sbrsbefore722topodist1) == "2"] <- "Naan"
names(sbrsbefore722topodist1)[names(sbrsbefore722topodist1) == "3"] <- "Talc"
sbrsbefore722topodist1$WhichClose <- colnames(sbrsbefore722topodist1)[apply(sbrsbefore722topodist1, 1, which.min)]
sbrsbefore722topodist1$Closedist <- pmin(sbrsbefore722topodist1$MilC, sbrsbefore722topodist1$Naan, sbrsbefore722topodist1$Talc)
sbrsbefore722topodist2 <- sbrsbefore722topodist1[-c(1, 2, 3), ]
# For 7/23 and 7/24
sbrswatergps72324 <- rbind(SBrs2water, sbrsallmtn72324)
sbrswatergps72324$BHSID <- as.factor(sbrswatergps72324$BHSID)
sbrs72324coords <- as.data.frame(sbrswatergps72324[ ,c("x", "y")])
sbrs72324restodata <- as.data.frame(sbrswatergps72324[ ,c(1:5, 8:34)])
# crssbrs is the coordinate system
spdfsbrs72324 <- SpatialPointsDataFrame(coords = sbrs72324coords, data = sbrs72324restodata, proj4string = crssbrs)
library(topoDistance)
sbrs72324topodist <- topoDist(DEM = sbrselevation, pts = spdfsbrs72324, directions = 8, paths = FALSE, zweight = 1)
sbrs72324topodist1 <- sbrs72324topodist[, c(1:2)]
sbrs72324topodist1 <- as.data.frame(sbrs72324topodist1)
names(sbrs72324topodist1)[names(sbrs72324topodist1) == "1"] <- "MilC"
names(sbrs72324topodist1)[names(sbrs72324topodist1) == "2"] <- "Naan"
sbrs72324topodist1$WhichClose <- colnames(sbrs72324topodist1)[apply(sbrs72324topodist1, 1, which.min)]
sbrs72324topodist1$Closedist <- pmin(sbrs72324topodist1$MilC, sbrs72324topodist1$Naan)
sbrs72324topodist2 <- sbrs72324topodist1[-c(1,2), ]

# topoPathMap(sbrselevation, pts = spdfsbrs72324, topoPaths = sbrs72324topodist, type = "hillshade",pathWidth = 4, cex = 2, bg = "blue")

# 7/25 and after
sbrswatergps725after <- rbind(SBrs3water, sbrsallmtn725aafter)
sbrswatergps725after$BHSID <- as.factor(sbrswatergps725after$BHSID)
sbrs725coords <- as.data.frame(sbrswatergps725after[ ,c("x", "y")])
sbrs725restodata <- as.data.frame(sbrswatergps725after[ ,c(1:5, 8:34)])
# crssbrs is already coordinate system
spdfsbrs725 <- SpatialPointsDataFrame(coords = sbrs725coords, data = sbrs725restodata, proj4string = crssbrs)
library(topoDistance)
sbrs725topodist <- topoDist(DEM = sbrselevation, pts = spdfsbrs725, directions = 8, paths = FALSE, zweight = 1)
sbrs725topodist1 <- sbrs725topodist[, c(1:3)]
sbrs725topodist1 <- as.data.frame(sbrs725topodist1)
names(sbrs725topodist1)[names(sbrs725topodist1) == "1"] <- "MilC"
names(sbrs725topodist1)[names(sbrs725topodist1) == "2"] <- "Naan"
names(sbrs725topodist1)[names(sbrs725topodist1) == "3"] <- "Talc"
sbrs725topodist1$WhichClose <- colnames(sbrs725topodist1)[apply(sbrs725topodist1, 1, which.min)]
sbrs725topodist1$Closedist <- pmin(sbrs725topodist1$MilC, sbrs725topodist1$Naan, sbrs725topodist1$Talc)
sbrs725topodist2 <- sbrs725topodist1[-c(1, 2, 3), ]
# Putting everything together INCORRECTLY
# sbrsallmtn2
# sbrsbefore722topodist2, sbrs72324topodist3, sbrs725topodist2
# sbrs72324topodist2$Talc <- NA
# sbrs72324topodist3 <- sbrs72324topodist2[, c("MilC", "Naan", "Talc", "WhichClose", "Closedist")]
# sbrsalltopodist <- rbind(sbrsbefore722topodist2, sbrs72324topodist3, sbrs725topodist2)
# sbrsallmtndistwater <- cbind(sbrsallmtn2, sbrsalltopodist[, 4:5, drop = FALSE])
# Putting everything together correctly
#Before 7/22
sbrsbefore722distwater <- cbind(sbrsallmtn722andbefore, sbrsbefore722topodist2[, 4:5, drop = FALSE])
# 7/23 and 7/24
sbrs72324distwater <- cbind(sbrsallmtn72324, sbrs72324topodist2[, 3:4, drop = FALSE])
# 7/25 and after
sbrs725distwater <- cbind(sbrsallmtn725aafter, sbrs725topodist2[, 4:5, drop = FALSE])
# Combining them all
sbrsallmtndistwater <- rbind(sbrsbefore722distwater, sbrs72324distwater, sbrs725distwater)

# Combining all four mountain ranges
View(nopaallmtnwdistwater)
View(cmprallmtnwdistwater)
View(marballmtndistwater)
sbrsallmtndistwater

cmprallmtnwdistwater1 <- cmprallmtnwdistwater[, -c(35:36)]
allmtndistwater <- rbind(marballmtndistwater, sbrsallmtndistwater, nopaallmtnwdistwater, cmprallmtnwdistwater1)

View(allmtndistwater)
par(mfrow = c(2,2))
boxplot(Closedist ~ Month, data = allmtndistwater[allmtndistwater$MountainRange == "Marb", ], ylab = "Distance (m)", main = "Marbles (n =10)", ylim = c(0, 16000))
boxplot(Closedist ~ Month, data = allmtndistwater[allmtndistwater$MountainRange == "BrsS", ], ylab = "Distance (m)", main = "South Bristols (n = 6)", ylim = c(0, 16000))
boxplot(Closedist ~ Month, data = allmtndistwater[allmtndistwater$MountainRange == "Nopa", ], ylab = "Distance (m)", main = "Nopah (n = 4)", ylim = c(0, 16000))
boxplot(Closedist ~ Month, data = allmtndistwater[allmtndistwater$MountainRange == "CMPR", ], ylab = "Distance (m)", main = "Castle Piute (n = 2)", ylim = c(0, 16000))
title("Distance to the Nearest Water Source by Month", line = -1, outer = TRUE)
dev.off()


```
To calculate the angle of movement relative to the nearest water source. I first read in the cleaned csv calculated from the previous chunk of code b/c of discrepancies with the time of day stuff.


```{r}
library(geosphere)
stepturndistallmtn <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/stepturningdist42920.csv")
AllWater <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/Summer2019WaterSources.csv")
stepturndistallmtn1 <- merge(stepturndistallmtn, AllWater, by.x = "WhichClose", by.y = "WhichClose")
p1 <- stepturndistallmtn1[, c(8,9)]
p1 <- as.matrix(p1)
p2 <- stepturndistallmtn1[, c(39, 38)]
p2 <- as.matrix(p2)
stepturndistallmtn1$birdflydisttowater <- distGeo(p1, p2)
stepturndistallmtn2 <- stepturndistallmtn1[with(stepturndistallmtn1, order(MountainRange, BHSID, DateTimeLocalTestct)), ]

# Double checking everything ok - Comparing between as the bird flies and topographic distance by mountain range - we good
stepturndistallmtn2$difbirdtopo <- stepturndistallmtn2$Closedist - stepturndistallmtn2$birdflydisttowater
boxplot(difbirdtopo ~ MountainRange, data = stepturndistallmtn2)

# To calculate the angle of movement relative to water
# To calculate the step length of movement as a bird flies in meters
#stepturndistallmtn2$movestepbirdfly <- (stepturndistallmtn2$step * 1000)
# library(dplyr)
# library(moveHMM)
# names(stepturndistallmtn2)[names(stepturndistallmtn2) == "x"] <- "Longitude"
# names(stepturndistallmtn2)[names(stepturndistallmtn2) == "y"] <- "Latitude"
# stepturndistallmtn2 <- prepData(stepturndistallmtn2, type = "LL", coordNames = c("Longitude", "Latitude"))
stepturndistallmtn2$laglongitude <- lead(stepturndistallmtn2$x, n = 1)
stepturndistallmtn2$laglatitude <- lead(stepturndistallmtn2$y, n = 1)
ab1 <- stepturndistallmtn2[ ,c(8, 9)]
ab1 <- as.matrix(ab1)
ab2 <- stepturndistallmtn2[ ,c(42, 43)]
ab2 <- as.matrix(ab2)
stepturndistallmtn2$geostplgthpostclean <- distGeo(ab1, ab2)


# p1 <- stepturndistallmtn1[, c(8,9)]
# p1 <- as.matrix(p1)
# p2 <- stepturndistallmtn1[, c(39, 38)]
# p2 <- as.matrix(p2)
# stepturndistallmtn1$birdflydisttowater <- distGeo(p1, p2)

# library(moveHMM)
# ptweminallrange <- prepData(tweminallrange, type = "LL", coordNames = c("Longitude", "Latitude"))

shift <- function(x, n){
  c(x[-(seq(n))], rep(NA, n))
}
stepturndistallmtn2$lagbirdflydisttowater <- shift(stepturndistallmtn2$birdflydisttowater, 1)
stepturndistallmtn2$angletowater <- acos((((stepturndistallmtn2$lagbirdflydisttowater)^2) - ((stepturndistallmtn2$geostplgthpostclean)^2) - ((stepturndistallmtn2$birdflydisttowater)^2)) / (-2 * (stepturndistallmtn2$geostplgthpostclean) * (stepturndistallmtn2$birdflydisttowater)))
# Deleting the rows whose results take in the locations of 2 sheep
rownames(stepturndistallmtn2) <- 1:nrow(stepturndistallmtn2)
stepturndistallmtn2[c(186, 1402, 2738, 3941, 5189, 6227, 6700, 7141, 7504, 7943, 8406, 8810, 9639, 10431, 11144, 11692, 12277), 46] <- NA
library(amt)
stepturndistallmtn2$angletowaterdegree <- as_degree(stepturndistallmtn2$angletowater)
```
To compare between movement immediately before coming into water and other movement 
- also movement before coming into water throughout the summer




```{r}
library(lubridate)
allrangetime1$DateTimect <- as.character(allrangetime1$DateTimect)
allrangetime1$DateTimect <- as.POSIXct(allrangetime1$DateTimect, tz = "America/Los_Angeles", format = "%Y-%m-%d %H:%M")
stepturndistallmtn2$DateTimeLocalTestct <- as.character(stepturndistallmtn2$DateTimeLocalTestct)
stepturndistallmtn2$DateTimeLocalTestct <- as.POSIXct(stepturndistallmtn2$DateTimeLocalTestct, tz = "America/Los_Angeles", format = "%Y-%m-%d %H:%M")
stepturndistallmtn2$beforevisit <- FALSE
for(row in 1:nrow(allrangetime1)){
  sheep_id <- as.character(allrangetime1$KI_Known_ID[row])
  drink_time <- allrangetime1$DateTimect[row]
  sheep_idxs <- which(stepturndistallmtn2$ID == sheep_id)
  drink_idx <- which((stepturndistallmtn2$DateTimeLocalTestct < as.Date(drink_time)) & (stepturndistallmtn2$DateTimeLocalTestct >= as.Date(drink_time - 3900)))
rowsbeforedrink <- intersect(sheep_idxs, drink_idx)
stepturndistallmtn2$beforevisit[rowsbeforedrink] <- TRUE
  }

#OLD CODE
# allrangetime1$KI_Known_ID
# steplengthallmtn1$ID
# allrangetime1$DateTimect
# steplengthallmtn1$DateTimeLocalTestct
# row <- 1
# sheep_id <- allrangetime1$KI_Known_ID[row]
# allrantime1[1]
# steplengthallmtn1$beforevisit <- FALSE
# for(row in 1:nrow(allrangetime1)){
#   sheep_id <- as.character(allrangetime1$KI_Known_ID[row])
#   drink_time <- allrangetime1$DateTimect[row]
#   sheep_idxs <- which(steplengthallmtn1$ID == sheep_id)
#   drink_idx <- which((steplengthallmtn1$DateTimeLocalTestct < as.Date(drink_time)) & (steplengthallmtn1$DateTimeLocalTestct >= as.Date(drink_time - 5400)))
# rowsbeforedrink <- intersect(sheep_idxs, drink_idx)
# steplengthallmtn1$beforevisit[rowsbeforedrink] <- TRUE
#  }

# Without breaking it out by mtn range


```




```{r}
# Step length different by time of day
# library(lubridate)

# as.numeric(format(t.str, "%H"))

# steplengthallmtn1$TimeLocal <- as.numeric(format(steplengthallmtn1$DateTimeLocalTestct, "%H"))

# steplengthallmtn1$TimeLocal <- hm(steplengthallmtn1$TimeLocal)
# steplengthallmtn1$Hour <- NA
# steplengthallmtn1$Hour <- hour(steplengthallmtn1$TimeLocal)
# plot(stplengthtopo ~ TimeLocal, data = steplengthallmtn1)

boxplot(stplengthtopo ~ TimeLocal, data = steplengthallmtn1, main = "Topographic Step Length By Hour for All Mountain Ranges", ylab = "Topographic Step Length (m)", xlab = "Time of Day")

```

Seeing if movement patterns are different when coming into water



```{r if movement different when coming into water}
# Without breaking it out by mtn range

# For angle of movement
steplengthallmtn1$beforevisit <- as.factor(steplengthallmtn1$beforevisit)
qqnorm(steplengthallmtn1$positangledegree)
qqline(steplengthallmtn1$positangledegree)
hist(steplengthallmtn1$positangledegree)
hist(steplengthallmtn1$positangledegree[steplengthallmtn1$beforevisit == "TRUE"])
hist(steplengthallmtn1$positangledegree[steplengthallmtn1$beforevisit == "FALSE"])
# Have to use a Mann-Whitney U Test b/c nonparametric
wilcox.test(steplengthallmtn1$positangledegree[steplengthallmtn1$beforevisit == "TRUE"], steplengthallmtn1$positangledegree[steplengthallmtn1$beforevisit == "FALSE"])
# W = 1137974, p-value = 0.1779
# No significant different between right before coming into water and other times, won't be able to tell if drank water based on angle of movement path
# Not significantly different when break it out by range either


# For step length
qqnorm(steplengthallmtn1$stplengthtopo)
qqline(steplengthallmtn1$stplengthtopo)
hist(steplengthallmtn1$stplengthtopo)
# Right skewed. Need to transform. Sqrt is still not perfect, but better.
hist(sqrt(steplengthallmtn1$stplengthtopo))
hist(sqrt(steplengthallmtn1$stplengthtopo))
t.test(sqrt(stplengthtopo) ~ beforevisit, data = stepturndistallmtn2)
# data:  sqrt(stplengthtopo) by beforevisit
# t = -1.4805, df = 192.94, p-value = 0.1404
# No significant difference- IS THIS THE RIGHT TEST? CONSIDERING EVERYTHING?
# Not significantly different by range either

# For distance to water
qqnorm(stepturndistallmtn2$Closedist)
qqline(stepturndistallmtn2$Closedist)
qqnorm(sqrt(stepturndistallmtn2$Closedist))
qqline(sqrt(stepturndistallmtn2$Closedist))
hist(stepturndistallmtn2$Closedist)
hist(sqrt(stepturndistallmtn2$Closedist))
# Transforming distance to water to make it normal
t.test((sqrt(Closedist)) ~ beforevisit, data = stepturndistallmtn2)
# t = 24.98, df = 209.52, p-value < 2.2e-16
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  21.21811 24.85394
# sample estimates:
# mean in group FALSE  mean in group TRUE 
#            45.63737            22.60135 
t.test((sqrt(Closedist)) ~ beforevisit, data = allgpsmarb)
t.test((sqrt(Closedist)) ~ beforevisit, data = allgpsbrs)
t.test((sqrt(Closedist)) ~ beforevisit, data = allgpsnopa)
t.test((sqrt(Closedist)) ~ beforevisit, data = allgpscmpr)

# For angle of movement relative to water
qqnorm(stepturndistallmtn2$angletowaterdegree)
qqline(stepturndistallmtn2$angletowaterdegree)
hist(stepturndistallmtn2$angletowaterdegree)
# relatively evenly spread
t.test(angletowaterdegree ~ beforevisit, data = stepturndistallmtn2)
# t = 1.2777, df = 186.74, p-value = 0.2029
# alternative hypothesis: true difference in means is not equal to 0
# 95 percent confidence interval:
#  -2.970941 13.894715
# sample estimates:
# mean in group FALSE  mean in group TRUE 
#            87.51017            82.04828 


# Do not include positangledegree (angle of movement) b/c not normally distributed
movevisitglm <- glm(beforevisit ~ positangledegree + sqrt(stplengthtopo) + sqrt(Closedist) + angletowaterdegree, data = stepturndistallmtn2, family = "binomial")
summary(movevisitglm)
plot(movevisitglm)
confint(movevisitglm)


# glm removing least significant variable
movevisitglmw3 <- glm(beforevisit ~ sqrt(stplengthtopo) + sqrt(Closedist), data = stepturndistallmtn2, family = "binomial")
summary(movevisitglmw3)
#                      Estimate Std. Error z value Pr(>|z|)    
# (Intercept)         -1.698907   0.183422  -9.262   <2e-16 ***
# sqrt(stplengthtopo) -0.012580   0.009057  -1.389    0.165    
# sqrt(Closedist)     -0.075234   0.005553 -13.549   <2e-16 ***
#    Null deviance: 1973.5  on 12962  degrees of freedom
# Residual deviance: 1716.7  on 12960  degrees of freedom
# AIC: 1722.7


# glm removing another variable - BASED ON AIC SCORES SHOULD USE THIS ONE????
movevisitglmw2 <- glm(beforevisit ~ sqrt(Closedist), data = stepturndistallmtn2, family = "binomial")
summary(movevisitglmw2)
plot(movevisitglmw2)
anova(movevisitglmw2, movevisitglmw3, test = "Chisq")
with(summary(movevisitglmw2), 1 - deviance/null.deviance)
#                  Estimate Std. Error z value Pr(>|z|)    
# (Intercept)     -1.859468   0.145276   -12.8   <2e-16 ***
# sqrt(Closedist) -0.073679   0.005416   -13.6   <2e-16 ***
#                    Null deviance: 1973.5  on 12962  degrees of freedom
# Residual deviance: 1718.7  on 12961  degrees of freedom
# AIC: 1722.7

movevisitglmbunnny <- glm(beforevisit ~ positangledegree + stplengthtopo + Closedist + angletowaterdegree, data = stepturndistallmtn2, family = "binomial")
summary(movevisitglmbunnny)
#                      Estimate Std. Error z value Pr(>|z|)    
# (Intercept)        -2.2587415  0.2151446 -10.499   <2e-16 ***
# positangledegree   -0.0010445  0.0013730  -0.761    0.447    
# stplengthtopo      -0.0004467  0.0003426  -1.304    0.192    
# Closedist          -0.0014207  0.0001332 -10.668   <2e-16 ***
# angletowaterdegree -0.0021334  0.0013480  -1.583    0.114 

movevisitglmbunnny1 <- glm(beforevisit ~ stplengthtopo + Closedist + angletowaterdegree, data = stepturndistallmtn2, family = "binomial")
summary(movevisitglmbunnny1)
# (Intercept)        -2.3554214  0.1747662 -13.478   <2e-16 ***
# stplengthtopo      -0.0004162  0.0003374  -1.234    0.217    
# Closedist          -0.0014195  0.0001331 -10.666   <2e-16 ***
# angletowaterdegree -0.0020983  0.0013500  -1.554    0.120   

movevisitglmbunnny2 <- glm(beforevisit ~ Closedist + angletowaterdegree, data = stepturndistallmtn3, family = "binomial")
summary(movevisitglmbunnny2)
#                      Estimate Std. Error z value Pr(>|z|)    
# (Intercept)        -2.4362696  0.1671173 -14.578   <2e-16 ***
# Closedist          -0.0014213  0.0001352 -10.511   <2e-16 ***
# angletowaterdegree -0.0018710  0.0013796  -1.356    0.175

movevisitglmbunnny3 <- glm(beforevisit ~ Closedist, data = stepturndistallmtn3, family = "binomial")
summary(movevisitglmbunnny3)
with(summary(movevisitglmbunnny3), 1 - deviance/null.deviance)
#               Estimate Std. Error z value Pr(>|z|)    
# (Intercept) -2.5912475  0.1146888  -22.59   <2e-16 ***
# Closedist   -0.0014125  0.0001301  -10.85   <2e-16 ***

# anova(movevisitglmbunnny2, movevisitglmbunnny3)
# doens't work/

# Seeing if there is a correlation between turning angle and step length
plot(steplengthallmtn1$stplengthtopo ~ steplengthallmtn1$positangledegree)
# no correlation

# Seeing if there is a correlation between angle of movement relative to water and distance to water
plot(stepturndistallmtn2$Closedist ~ stepturndistallmtn2$angletowaterdegree)
# no correlation

library("Hmisc")
movevar <- stepturndistallmtn2[ , c(31, 33, 37, 44)]
movevarres <- rcorr(as.matrix(movevar), type = "pearson")


## 9/3/2020
library(lme4)
library(car)
# Percentvisitedlmer <- glmer(NumIndSheep ~ dayl..s. + srad..W.m.2. + tmax..deg.c. + tmin..deg.c. + vp..Pa. + MeanNDVI + (1|MountainRange), data = allenvvisit2, family = "poisson")

# Scaling independent variables - scaling is done by dividing the centered columns of x by their standard deviations. If put center as false, then would divide by root mean square
# https://stackoverflow.com/questions/20256028/understanding-scale-in-r
# allenvvisit1$scaledayl <- scale(allenvvisit1$dayl..s., center = TRUE, scale = TRUE)

stepturndistallmtn2$Date <- as.factor(stepturndistallmtn2$Date)
stepturndistallmtn2a <- stepturndistallmtn2
stepturndistallmtn2a$scalepositangledegree <- scale(stepturndistallmtn2a$positangledegree, center = TRUE, scale = TRUE)
stepturndistallmtn2a$scalestplengthtopo <- scale(stepturndistallmtn2a$stplengthtopo, center = TRUE, scale = TRUE)
stepturndistallmtn2a$scaleClosedist <- scale(stepturndistallmtn2a$Closedist, center = TRUE, scale = TRUE)
stepturndistallmtn2a$scaleangletowaterdegree <- scale(stepturndistallmtn2a$angletowaterdegree, center = TRUE, scale = TRUE)

moveviz <- glmer(beforevisit ~ scalepositangledegree + scalestplengthtopo + scaleClosedist + scaleangletowaterdegree + (1|Date) + (1|BHSID), data = stepturndistallmtn2a, family = binomial(link = "logit"))
summary(moveviz)

# Unsuccessful attempts to calculate R squared for logistic mixed effect models
install.packages("piecewiseSEM")
library(piecewiseSEM)
rsquared(moveviz, method = "delta")
library(MuMIn)
r.squaredGLMM(moveviz)
library(pscl)
pR2(moveviz)
r2beta(moveviz, method = 'kr', partial = T)

plot(moveviz)
plot(resid(moveviz))
library(car)
# boxTidwell(beforevisit ~ scaleClosedist, data = stepturndistallmtn2a)
probabilities <- predict(moveviz, type = "response")
predicted.classes <- ifelse(probabilities > 0.5, "pos", "neg")
head(predicted.classes)
nrow(na.omit(happy))
# if the predictions are linearly related to the variables
# http://www.sthda.com/english/articles/36-classification-methods-essentials/148-logistic-regression-assumptions-and-diagnostics-in-r/
library(dplyr)
library(tidyverse)
happy <- na.omit(select(stepturndistallmtn2a, c(scalepositangledegree, scalestplengthtopo, scaleClosedist, scaleangletowaterdegree)))
head(happy)
happy1 <- happy %>%
  mutate(logit = log(probabilities/(1-probabilities))) %>%
  gather(key = "predictors", value = "predictor.value", -logit)
ggplot(happy1, aes(logit, predictor.value))+
  geom_point(size = 0.5, alpha = 0.5) +
  geom_smooth(method = "loess") + 
  theme_bw() + 
  facet_wrap(~predictors, scales = "free_y")

# problem?
#qqnorm(stepturndistallmtn2a$scaleClosedist)
#qqline(stepturndistallmtn2a$scaleClosedist)

# Deleting scalesteplengthtopo
moveviz1 <- glmer(beforevisit ~ scalepositangledegree + scaleClosedist + scaleangletowaterdegree + (1|Date) + (1|BHSID), data = stepturndistallmtn2a, family = binomial(link = "logit"))
summary(moveviz1)

# Deleting scalepositangeldegree
moveviz2 <- glmer(beforevisit ~ scaleClosedist + scaleangletowaterdegree + (1|Date) + (1|BHSID), data = stepturndistallmtn2a, family = binomial(link = "logit"))
summary(moveviz2)

# Deleting scaleangletowaterdegree
moveviz3 <- glmer(beforevisit ~ scaleClosedist + (1|Date) + (1|BHSID), data = stepturndistallmtn2a, family = binomial(link = "logit"))
summary(moveviz3)



# Checking linearity in each variable
# library(ggplot2)
# ggplot(data.frame(x1=stepturndistallmtn2a$scalepositangledegree,pearson=residuals(moveviz,type="pearson")),
#      aes(x=x1,y=pearson)) +
#     geom_point() +
#     theme_bw()
```


- difference in 4 var between mountain ranges
- difference in 4 var by month within each mountain range

```{r}
# Difference in 4 var between mountain ranges

# For angle of movement
# not parametric
boxplot(positangledegree ~ MountainRange, data = stepturndistallmtn2)
# Lol. clearly no difference
kruskal.test(positangledegree ~ MountainRange, data = stepturndistallmtn2)
# Kruskal-Wallis chi-squared = 4.4321, df = 3, p-value = 0.2184
# No significant difference between ranges

# Step length
boxplot(stplengthtopo ~ MountainRange, data = stepturndistallmtn2)
stplengthtopomtnrange <- aov(sqrt(stplengthtopo) ~ MountainRange, data = stepturndistallmtn2)
summary.lm(stplengthtopomtnrange)
# Residual standard error: 7.89 on 12959 degrees of freedom
# Multiple R-squared:  0.0009177,	Adjusted R-squared:  0.0006864 
# F-statistic: 3.968 on 3 and 12959 DF,  p-value: 0.00774
TukeyHSD(stplengthtopomtnrange)
#                  diff        lwr          upr     p adj
# CMPR-BrsS -0.63699275 -1.3550349  0.081049361 0.1028872
# Marb-BrsS  0.09208716 -0.3185786  0.502752943 0.9392440
# Nopa-BrsS -0.48560913 -1.0258870  0.054668717 0.0959087
# Marb-CMPR  0.72907991 -0.0140541  1.472213923 0.0568052
# Nopa-CMPR  0.15138362 -0.6705056  0.973272863 0.9649692
# Nopa-Marb -0.57769629 -1.1509012 -0.004491403 0.0473881
# only 1 combo significantly differently, and only just that

# Distance from water
boxplot(Closedist ~ MountainRange, data = stepturndistallmtn2)
disttowatmtnrange <- aov(sqrt(Closedist) ~ MountainRange, data = stepturndistallmtn2)
summary.lm(disttowatmtnrange)
# Residual standard error: 23.32 on 12959 degrees of freedom
# Multiple R-squared:  0.05368,	Adjusted R-squared:  0.05346 
# F-statistic: 245.1 on 3 and 12959 DF,  p-value: < 2.2e-16
TukeyHSD(disttowatmtnrange)
#                 diff         lwr        upr     p adj
# CMPR-BrsS -15.735613 -17.8582929 -13.612933 0.0000000
# Marb-BrsS  -9.270328 -10.4843405  -8.056315 0.0000000
# Nopa-BrsS   1.949569   0.3523961   3.546741 0.0092945
# Marb-CMPR   6.465285   4.2684278   8.662142 0.0000000
# Nopa-CMPR  17.685181  15.2555076  20.114855 0.0000000
# Nopa-Marb  11.219896   9.5253849  12.914408 0.0000000
# This may not mean much b/c differential abundance of water sources in mtn ranges, and differential sex ratio of collared bighorn in each mtn range.

# Angle of Movement relative to water
boxplot(angletowaterdegree ~ MountainRange, data = stepturndistallmtn2)
angletowatmtnrange <- aov(angletowaterdegree ~ MountainRange, data = stepturndistallmtn2)
summary.lm(angletowatmtnrange)
# Multiple R-squared:  0.0005197,	Adjusted R-squared:  0.0002867 
# F-statistic: 2.231 on 3 and 12872 DF,  p-value: 0.08243
# Not significantly different between ranges

# Difference in 4 var by month by Mountain range
stepturndistallmtn2$Month <- as.factor(stepturndistallmtn2$Month)
allgpsmarb <- stepturndistallmtn2[stepturndistallmtn2$MountainRange == "Marb", ]
allgpsbrs <- stepturndistallmtn2[stepturndistallmtn2$MountainRange == "BrsS", ]
allgpsnopa <- stepturndistallmtn2[stepturndistallmtn2$MountainRange == "Nopa", ]
allgpscmpr <- stepturndistallmtn2[stepturndistallmtn2$MountainRange == "CMPR", ]



#Angle of movement
# All mtn ranges combined
boxplot(positangledegree ~ Month, data = stepturndistallmtn2)
kruskal.test(positangledegree ~ Month, data = stepturndistallmtn2)
# Kruskal-Wallis chi-squared = 11.781, df = 3, p-value = 0.008173
library(dunn.test)
attach(stepturndistallmtn2)
dunn.test(x = positangledegree, g = Month)
# June different from July and August is the significant difference
# Marbles
boxplot(positangledegree ~ Month, data = allgpsmarb)
kruskal.test(positangledegree ~ Month, data = allgpsmarb)
# Kruskal-Wallis chi-squared = 5.9113, df = 3, p-value = 0.116
#South Bristols
boxplot(positangledegree ~ Month, data = allgpsbrs)
kruskal.test(positangledegree ~ Month, data = allgpsbrs)
# Kruskal-Wallis chi-squared = 8.4805, df = 2, p-value = 0.0144
attach(allgpsbrs)
dunn.test(x = positangledegree, g = Month)
# June is different from July and August
# Nopah
boxplot(positangledegree ~ Month, data = allgpsnopa)
kruskal.test(positangledegree ~ Month, data = allgpsnopa)
# Kruskal-Wallis chi-squared = 1.1648, df = 2, p-value = 0.5586
# Castle Piute
boxplot(positangledegree ~ Month, data = allgpscmpr)
kruskal.test(positangledegree ~ Month, data = allgpscmpr)
# Kruskal-Wallis chi-squared = 4.6685, df = 2, p-value = 0.09688

# Step length
# All mtn ranges combined
boxplot(stplengthtopo ~ Month, data = stepturndistallmtn2)
stplgthallmonth <- aov(sqrt(stplengthtopo) ~ Month, data = stepturndistallmtn2)
summary.lm(stplgthallmonth)
# Multiple R-squared:  0.005763,	Adjusted R-squared:  0.005533 
# F-statistic: 25.04 on 3 and 12959 DF,  p-value: 3.792e-16
TukeyHSD(stplgthallmonth)
#           diff        lwr         upr     p adj
# 6-5 -0.5153772 -1.4841785  0.45342414 0.5202827
# 7-5  0.8571682 -0.1064198  1.82075620 0.1014020
# 8-5  0.2780684 -0.7246131  1.28075000 0.8921650
# 7-6  1.3725454  0.9642265  1.78086429 0.0000000
# 8-6  0.7934456  0.2998944  1.28699687 0.0002131
# 8-7 -0.5790998 -1.0623374 -0.09586217 0.0111912
# Marbles
boxplot(stplengthtopo ~ Month, data = allgpsmarb)
stplgthmarbmonth <- aov(sqrt(stplengthtopo) ~ Month, data = allgpsmarb)
summary.lm(stplgthmarbmonth)
TukeyHSD(stplgthmarbmonth)
# Multiple R-squared:  0.001031,	Adjusted R-squared:  0.000282 
# F-statistic: 1.376 on 3 and 3999 DF,  p-value: 0.248
# No difference in Marbles
# South Bristols
boxplot(stplengthtopo ~ Month, data = allgpsbrs)
stplgthbrsmonth <- aov(sqrt(stplengthtopo) ~ Month, data = allgpsbrs)
summary.lm(stplgthbrsmonth)
# Multiple R-squared:  0.01942,	Adjusted R-squared:  0.01911 
# F-statistic: 61.64 on 2 and 6224 DF,  p-value: < 2.2e-16
TukeyHSD(stplgthbrsmonth)
#           diff       lwr        upr     p adj
# 7-6  2.5098551  1.974566  3.0451440 0.0000000
# 8-6  1.7402494  1.047597  2.4329020 0.0000000
# 8-7 -0.7696057 -1.451955 -0.0872564 0.0223661
# Nopah
boxplot(stplengthtopo ~ Month, data = allgpsnopa)
stplgthnopamonth <- aov(sqrt(stplengthtopo) ~ Month, data = allgpsnopa)
summary.lm(stplgthnopamonth)
# Multiple R-squared:  0.001826,	Adjusted R-squared:  0.0007269 
# F-statistic: 1.661 on 2 and 1816 DF,  p-value: 0.1902
# Not significantly different in Nopa
TukeyHSD(stplgthnopamonth)
# Castle Piute
boxplot(stplengthtopo ~ Month, data = allgpscmpr)
steplgthcmprmonth <- aov(sqrt(stplengthtopo) ~ Month, data = allgpscmpr)
summary.lm(steplgthcmprmonth)
TukeyHSD(steplgthcmprmonth)
# Multiple R-squared:  0.00625,	Adjusted R-squared:  0.004069 
# F-statistic: 2.865 on 2 and 911 DF,  p-value: 0.0575

# Distance to water
# All mtn ranges combined
boxplot(Closedist ~ Month, data = stepturndistallmtn2)
closedistall <- aov(sqrt(Closedist) ~ Month, data = stepturndistallmtn2)
summary.lm(closedistall)
# Multiple R-squared:  0.04764,	Adjusted R-squared:  0.04742 
# F-statistic: 216.1 on 3 and 12959 DF,  p-value: < 2.2e-16
TukeyHSD(closedistall)
#           diff        lwr        upr     p adj
# 6-5   5.038178   2.158072   7.918284 0.0000416
# 7-5   1.839334  -1.025273   4.703942 0.3507222
# 8-5  -9.248811 -12.229638  -6.267984 0.0000000
# 7-6  -3.198844  -4.412716  -1.984971 0.0000000
# 8-6 -14.286989 -15.754245 -12.819733 0.0000000
# 8-7 -11.088146 -12.524741  -9.651550 0.0000000
# Marbles
boxplot(Closedist ~ Month, data = allgpsmarb)
closedistmarb <- aov(sqrt(Closedist) ~ Month, data = allgpsmarb)
summary.lm(closedistmarb)
# Multiple R-squared:  0.02188,	Adjusted R-squared:  0.02114 
# F-statistic: 29.82 on 3 and 3999 DF,  p-value: < 2.2e-16
TukeyHSD(closedistmarb)
#           diff       lwr       upr     p adj
# 6-5 -3.5871615 -5.800328 -1.373995 0.0001857
# 7-5 -7.3590310 -9.618777 -5.099285 0.0000000
# 8-5 -6.7107501 -9.241728 -4.179773 0.0000000
# 7-6 -3.7718695 -5.364838 -2.178901 0.0000000
# 8-6 -3.1235886 -5.082401 -1.164776 0.0002479
# 8-7  0.6482809 -1.363010  2.659572 0.8410124
eta_squared(closedistmarb, partial = FALSE)

# South Bristols
boxplot(Closedist ~ Month, data = allgpsbrs)
closedistbrs <- aov(sqrt(Closedist) ~ Month, data = allgpsbrs)
summary.lm(closedistbrs)
# Multiple R-squared:  0.04903,	Adjusted R-squared:  0.04872 
# F-statistic: 160.4 on 2 and 6224 DF,  p-value: < 2.2e-16
TukeyHSD(closedistbrs)
#           diff        lwr        upr p adj
# 7-6  -7.327503  -9.132527  -5.522479     0
# 8-6 -17.665846 -20.001509 -15.330183     0
# 8-7 -10.338343 -12.639262  -8.037423     0
eta_squared(closedistbrs, partial = FALSE)

# Nopah
boxplot(Closedist ~ Month, data = allgpsnopa)
closedistnopa <- aov(sqrt(Closedist) ~ Month, data = allgpsnopa)
summary.lm(closedistnopa)
# Multiple R-squared:  0.3058,	Adjusted R-squared:  0.305 
# F-statistic:   400 on 2 and 1816 DF,  p-value: < 2.2e-16
TukeyHSD(closedistnopa)
#           diff        lwr        upr   p adj
# 7-6  -5.371773  -7.973494  -2.770052 4.1e-06
# 8-6 -36.113580 -39.425255 -32.801905 0.0e+00
# 8-7 -30.741807 -33.538857 -27.944757 0.0e+00
eta_squared(closedistnopa, partial = FALSE)

# Castle Piute
boxplot(Closedist ~ Month, data = allgpscmpr)
closedistcmpr <- aov(sqrt(Closedist) ~ Month, data = allgpscmpr)
summary.lm(closedistcmpr)
# Multiple R-squared:  0.04742,	Adjusted R-squared:  0.04533 
# F-statistic: 22.67 on 2 and 911 DF,  p-value: 2.454e-10
TukeyHSD(closedistcmpr)
#          diff       lwr      upr     p adj
# 7-6  3.679604  1.951014 5.408194 0.0000021
# 8-6  3.388210  2.140640 4.635779 0.0000000
# 8-7 -0.291394 -1.855100 1.272312 0.8999157
eta_squared(closedistcmpr, partial = FALSE)

par(mfrow = c(2,2))
boxplot(sqrt(Closedist) ~ Month, data = allgpsmarb, ylab = "Distance to the Nearest Water Source (m)", main = "Marbles")
boxplot(sqrt(Closedist) ~ Month, data = allgpsbrs,  ylab = "Distance to the Nearest Water Source (m)", main = "South Bristols")
boxplot(sqrt(Closedist) ~ Month, data = allgpsnopa,  ylab = "Distance to the Nearest Water Source (m)", main = "Nopah")
boxplot(sqrt(Closedist) ~ Month, data = allgpscmpr,  ylab = "Distance to the Nearest Water Source (m)", main = "Castle Piutes")
dev.off()

par(mfrow = c(2,2))
boxplot(sqrt(Closedist) ~ Month, data = allgpsmarb, ylab = "Distance to the Nearest Water Source (m)", main = "Marbles")
boxplot(sqrt(Closedist) ~ Month, data = allgpsbrs,  ylab = "Distance to the Nearest Water Source (m)", main = "South Bristols")
boxplot(sqrt(Closedist) ~ Month, data = allgpsnopa,  ylab = "Distance to the Nearest Water Source (m)", main = "Nopah")
boxplot(sqrt(Closedist) ~ Month, data = allgpscmpr,  ylab = "Distance to the Nearest Water Source (m)", main = "Castle Piutes")
dev.off()

# Angle of movement relative to water
# All mtn ranges
boxplot(angletowaterdegree ~ Month, data = stepturndistallmtn2)
anglewaterall <- aov(angletowaterdegree ~ Month, data = stepturndistallmtn2)
summary.lm(anglewaterall)
# Multiple R-squared:  4.055e-05,	Adjusted R-squared:  -3.713e-05 
# F-statistic: 0.522 on 1 and 12874 DF,  p-value: 0.47
# Marbles
boxplot(angletowaterdegree ~ Month, data = allgpsmarb)
anglewatermarb <- aov(angletowaterdegree ~ Month, data = allgpsmarb)
summary.lm(anglewatermarb)
TukeyHSD(anglewatermarb)
# Multiple R-squared:  0.0001637,	Adjusted R-squared:  -0.0006259 
# F-statistic: 0.2073 on 3 and 3799 DF,  p-value: 0.8914
# South Bristols
boxplot(angletowaterdegree ~ Month, data = allgpsbrs)
anglewaterbrs <- aov(angletowaterdegree ~ Month, data = allgpsbrs)
summary.lm(anglewaterbrs)
TukeyHSD(anglewaterbrs)
#Nopah
boxplot(angletowaterdegree ~ Month, data = allgpsnopa)
anglewaternopa <- aov(angletowaterdegree ~ Month, data = allgpsnopa)
summary.lm(anglewaternopa)
TukeyHSD(anglewaternopa)
# Castle Piute
boxplot(angletowaterdegree ~ Month, data = allgpscmpr)
anglewatercmpr <- aov(angletowaterdegree ~ Month, data = allgpscmpr)
summary.lm(anglewatercmpr)
TukeyHSD(anglewatercmpr)
# No difference for any of these
```

See if there is any difference in 4 variable right before VTW  in May June SBrs/Marb vs VTW at other times- didn't work 

```{r}
allgpsmarbmay <- allgpsmarb[allgpsmarb$Month == "5", ]
allgpsmarbjune <- allgpsmarb[allgpsmarb$Month == "6", ]
allgpsbrsmay <- allgpsbrs[allgpsbrs$Month == "5", ]
allgpsbrsjune <- allgpsbrs[allgpsbrs$Month == "6", ]

# Angle of movement
wilcox.test(allgpsbrsmay$positangledegree[allgpsbrsmay$beforevisit == "TRUE"], allgpsbrsmay$positangledegree[allgpsbrsmay$beforevisit == "FALSE"])
# Not enough observations to test
wilcox.test(allgpsbrsjune$positangledegree[allgpsbrsjune$beforevisit == "TRUE"], allgpsbrsjune$positangledegree[allgpsbrsjune$beforevisit == "FALSE"])
# Not enough observations to test
wilcox.test(allgpsmarbmay$positangledegree[allgpsmarbmay$beforevisit == "TRUE"], allgpsmarbmay$positangledegree[allgpsmarbmay$beforevisit == "FALSE"])
# Not enough observations to test
wilcox.test(allgpsmarbjune$positangledegree[allgpsmarbjune$beforevisit == "TRUE"], allgpsmarbjune$positangledegree[allgpsmarbjune$beforevisit == "FALSE"])
# Can't test
```

Average distance away from water within 1.5 hrs of coming into water


```{r}
boxplot(stepturndistallmtn2$Closedist[stepturndistallmtn2$beforevisit == "TRUE"])
# mean = 662.258 m
# range = 0 - 2640.599
#  Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#    0.0   213.7   443.6   662.3  1066.9  2640.6 

# To make another column that covers 1.5 before and 1.5 after(essentially accounting for all the time they VTW)
library(lubridate)
stepturndistallmtn2$beforeaftervisit <- FALSE
for(row in 1:nrow(allrangetime1)){
  sheep_id1 <- as.character(allrangetime1$KI_Known_ID[row])
  drink_time1 <- allrangetime1$DateTimect[row]
  sheep_idxs1 <- which(stepturndistallmtn2$ID == sheep_id1)
  drink_idx1 <- which((stepturndistallmtn2$DateTimeLocalTestct <= as.Date(drink_time1 + 5400)) & (stepturndistallmtn2$DateTimeLocalTestct >= as.Date(drink_time1 - 5400)))
rowsbeforedrink1 <- intersect(sheep_idxs1, drink_idx1)
stepturndistallmtn2$beforeaftervisit[rowsbeforedrink1] <- TRUE
}
# now 697 true cases
summary(stepturndistallmtn2$Closedist[stepturndistallmtn2$beforeaftervisit == "TRUE"])
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#    0.0   293.2   753.7   945.5  1284.1  6942.8

nrow(stepturndistallmtn2[(stepturndistallmtn2$Closedist < 1284.1) & (stepturndistallmtn2$beforeaftervisit == "FALSE"), ])
#4740
nrow(stepturndistallmtn2[(stepturndistallmtn2$Closedist < 945.5) & (stepturndistallmtn2$beforeaftervisit == "FALSE"), ])
#3205
nrow(stepturndistallmtn2[(stepturndistallmtn2$Closedist < 753.7) & (stepturndistallmtn2$beforeaftervisit == "FALSE"), ])
# 2359
nrow(stepturndistallmtn2[(stepturndistallmtn2$Closedist < 293.2) & (stepturndistallmtn2$beforeaftervisit == "FALSE"), ])
#871
nrow(stepturndistallmtn2[(stepturndistallmtn2$Closedist < 293.2) & (stepturndistallmtn2$beforeaftervisit == "TRUE"), ])
# 175
# Most of the time, still not drinking water if at the distance from the water source
```

Linking Environmental Conditions and Bighorn Movement
average movement for an hour for the mtn range for a given bighorn  - can do because - currently wrong 


```{r}
## THIS IS ALL INCORRECT!!!!

# str(stepturndistallmtn2$Date) = Factor
# allenvvisit1$Date = factor
stepturndistallmtn2$Date <- as.character(stepturndistallmtn2$Date)
stepturndistallmtn2$Date <- as.Date(stepturndistallmtn2$Date, format = "%m/%d/%Y")
allenvvisit1$Date <- as.character(allenvvisit1$Date)
allenvvisit1$Date <- as.Date(allenvvisit1$Date)
names(allenvvisit1)[names(allenvvisit1) == "MtnRange"] <- "MountainRange"

# names(cmprindsheepvisitperday)[names(cmprindsheepvisitperday) == "rownames(cmprindsheepvisitperday)"] <- "Date"
levels(stepturndistallmtn2$MountainRange)
levels(allenvvisit1$MountainRange)
# Adding environmental variables to stepturndistallmtn2 movement variable dataframe
library(dplyr)
combined <- sort(union(levels(stepturndistallmtn2$MountainRange), levels(allenvvisit1$MountainRange)))
stepturndistallmtn3 <- left_join(mutate(stepturndistallmtn2, MountainRange = factor(MountainRange, levels = combined)), mutate(allenvvisit1[, c("Date", "MountainRange", "dayl..s.", "prcp..mm.day.", "srad..W.m.2.", "tmax..deg.c.", "tmin..deg.c.", "vp..Pa.", "MeanNDVI")], MountainRange = factor(MountainRange, levels = combined)))


# stepturndistallmtn3$Closedist
# stepturndistallmtn3$tmax..deg.c.
plot(Closedist ~ tmax..deg.c., data = stepturndistallmtn3)
hist(stepturndistallmtn3$Closedist)
hist(stepturndistallmtn3$tmax..deg.c.)
disttemp <- glm(Closedist ~ tmax..deg.c., data = stepturndistallmtn3, na.action = na.exclude)
with(summary(disttemp), 1 - deviance/null.deviance)
summary(disttemp)
plot(resid(disttemp))
library(rsq)
rsq(disttemp, adj = FALSE)

letsee <- data.frame(stepturndistallmtn3$tmax..deg.c., resid(disttemp))
plot(stepturndistallmtn3$tmax..deg.c., resid(disttemp))

distenv <- glm(Closedist ~ dayl..s. + srad..W.m.2. + tmin..deg.c. + tmax..deg.c. +  vp..Pa. + MeanNDVI, data = stepturndistallmtn3, na.action = na.exclude)
summary(distenv)
#                Estimate Std. Error t value Pr(>|t|)    
# (Intercept)  -3.071e+04  1.378e+03 -22.283  < 2e-16 ***
# dayl..s.      6.571e-01  2.631e-02  24.977  < 2e-16 ***
# srad..W.m.2. -3.036e+00  1.724e+00  -1.761 0.078322 .  
# tmin..deg.c. -1.120e+02  4.506e+01  -2.485 0.012951 *  
# tmax..deg.c.  1.049e+02  3.128e+01   3.354 0.000798 ***
# vp..Pa.       3.398e-01  4.606e-01   0.738 0.460663    
# MeanNDVI     -2.480e+03  9.777e+02  -2.537 0.011202 * 

# Minus vapor pressure
distenv1 <- glm(Closedist ~ dayl..s. + srad..W.m.2. + tmin..deg.c. + tmax..deg.c. + MeanNDVI, data = stepturndistallmtn3, na.action = na.exclude)
summary(distenv1)
#                Estimate Std. Error t value Pr(>|t|)    
# (Intercept)  -3.048e+04  1.343e+03 -22.688  < 2e-16 ***
# dayl..s.      6.532e-01  2.577e-02  25.351  < 2e-16 ***
# srad..W.m.2. -3.273e+00  1.694e+00  -1.932  0.05344 .  
# tmin..deg.c. -9.251e+01  3.651e+01  -2.534  0.01130 *  
# tmax..deg.c.  1.052e+02  3.128e+01   3.364  0.00077 ***
# MeanNDVI     -2.477e+03  9.777e+02  -2.533  0.01131 * 

# Minus solar radiation
distenv2 <- glm(Closedist ~ dayl..s. + tmin..deg.c. + tmax..deg.c. + MeanNDVI, data = stepturndistallmtn3, na.action = na.exclude)
summary(distenv2)
#                Estimate Std. Error t value Pr(>|t|)    
# (Intercept)  -3.094e+04  1.323e+03 -23.391  < 2e-16 ***
# dayl..s.      6.470e-01  2.557e-02  25.303  < 2e-16 ***
# tmin..deg.c. -2.788e+01  1.461e+01  -1.908   0.0565 .  
# tmax..deg.c.  4.927e+01  1.180e+01   4.175 2.99e-05 ***
# MeanNDVI     -3.726e+03  7.334e+02  -5.080 3.82e-07 ***

# Minus tmin
distenv3 <- glm(Closedist ~ dayl..s. + tmax..deg.c. + MeanNDVI, data = stepturndistallmtn3, na.action = na.exclude)
summary(distenv3)
#                Estimate Std. Error t value Pr(>|t|)    
# (Intercept)  -3.174e+04  1.254e+03 -25.310  < 2e-16 ***
# dayl..s.      6.639e-01  2.399e-02  27.671  < 2e-16 ***
# tmax..deg.c.  2.983e+01  5.953e+00   5.011 5.48e-07 ***
# MeanNDVI     -3.280e+03  6.953e+02  -4.718 2.41e-06 ***
rsq(distenv3, adj = FALSE)
with(summary(distenv3), 1 - deviance/null.deviance)
# 0.058

plot(allenvvisit2$NumIndSheep, resid(zeroinflpsclmodel1), xlab = "Number of Individual Sheep", ylab = "Residuals", main = "Residual Plot Max Temp")

# independent normally distributed
qqnorm(stepturndistallmtn3$dayl..s.)
qqline(stepturndistallmtn3$dayl..s.)
hist(stepturndistallmtn3$dayl..s.)

# merge(data frameA,data frameB,by="ID")


```
if ewe are with lambs makes a difference in terms of movement to water


```{r}
movbefvis <- stepturndistallmtn3[stepturndistallmtn3$beforevisit == TRUE, ]
# Changing Sex to F and M
library(plyr)
library(lubridate)
movbefvis$Sex <- revalue(movbefvis$Sex, c("E" = "F", "R" = "M"))
ewemovbefvis <- movbefvis[movbefvis$Sex == "F", ]
atleastoneewe$KI_Known_ID <- as.character(atleastoneewe$KI_Known_ID)
atleastoneeweandlamb <- atleastoneewe[atleastoneewe$GO_NoLambs > 0, ]
ewemovbefvis$visitedwithlamb <- FALSE
# already subset to only rows before visit, so only need to figure out which one of these had a lamb during the visit
for(row in 1:nrow(atleastoneeweandlamb)){
  sheep_idzz <- as.character(ewemovbefvis$ID[row])
  sheep_idzzx <- which(atleastoneeweandlamb$KI_Known_ID == sheep_idzz)
  drink_timexx <- atleastoneeweandlamb$DateTimect[row]
  drink_timexxz <- which((ewemovbefvis$DateTimeLocalTestct < as.Date(drink_timexx)) & (ewemovbefvis$DateTimeLocalTestct >= as.Date(drink_timexx - 5400)))
rowswithlambs <- intersect(sheep_idzzx, drink_timexxz)
ewemovbefvis$visitedwithlamb[rowswithlambs] <- TRUE
}
### They are all false - no cases of 1 hr movement before ewe coming in with lamb????? Weird. Therefore, no need to compare.
```
how much they move vs. how much they visit water to average for the day

- THis is stupid. It is worse version of the linear regression looking at the perc
```{r}
listall <- split(stepturndistallmtn3, stepturndistallmtn3$ID)
listallmean <- list(1, 2, 3)
for(i in 1:length(listall)){
listallmean[[i]] <- as.data.frame(tapply(X= listall[[i]]$stplengthtopo, INDEX = listall[[i]]$Date, FUN = mean, na.rm = TRUE))
listallmean[[i]] <- cbind(rownames(listallmean[[i]]), data.frame(listallmean[[i]], row.names = NULL))
names(listallmean[[i]])[names(listallmean[[i]]) == "tapply.X...listall..i...stplengthtopo..INDEX...listall..i...Date.."] <- "MeanTopoMoveHour"
names(listallmean[[i]])[names(listallmean[[i]]) == "rownames(listallmean[[i]])"] <- "Date"
listallmean[[i]]$BHSID <- NA
listallmean[[i]]$BHSID <- as.factor(listallmean[[i]]$BHSID)
}
listallmean[[1]]$BHSID <- "BHS_1577"
listallmean[[2]]$BHSID <- "BHS_1580"
listallmean[[3]]$BHSID <- "BHS_1582"
listallmean[[4]]$BHSID <- "BHS_1584"
listallmean[[5]]$BHSID <- "BHS_1589"
listallmean[[6]]$BHSID <- "BHS_1682"
listallmean[[7]]$BHSID <- "BHS_1683"
listallmean[[8]]$BHSID <- "BHS_1684"
listallmean[[9]]$BHSID <- "BHS_1685"
listallmean[[10]]$BHSID <- "BHS_1686"
listallmean[[11]]$BHSID <- "BHS_1687"
listallmean[[12]]$BHSID <- "BHS_1688"
listallmean[[13]]$BHSID <- "BHS_1689"
listallmean[[14]]$BHSID <- "BHS_1730"
listallmean[[15]]$BHSID <- "BHS_1733"
listallmean[[16]]$BHSID <- "BHS_1736"
listallmean[[17]]$BHSID <- "BHS_1739"
listallmean[[18]]$BHSID <- "BHS_1740"
dailymeanstplength <- rbind(listallmean[[1]], listallmean[[2]], listallmean[[3]], listallmean[[4]], listallmean[[5]], listallmean[[6]], listallmean[[7]], listallmean[[8]], listallmean[[9]], listallmean[[10]], listallmean[[11]], listallmean[[12]], listallmean[[13]], listallmean[[14]], listallmean[[15]], listallmean[[16]], listallmean[[17]], listallmean[[18]])
# Setting up the number of visits by a sheep in a day to combine
marballsheepvisitsdaymove <- marballsheepvisitsday[(marballsheepvisitsday$Var1 == "BHS_1367") |  (marballsheepvisitsday$Var1 == "BHS_1365") | (marballsheepvisitsday$Var1 == "BHS_1361") |(marballsheepvisitsday$Var1 == "BHS_1362") | (marballsheepvisitsday$Var1 == "BHS_1357") | (marballsheepvisitsday$Var1 == "BHS_1416") | (marballsheepvisitsday$Var1 == "BHS_1421") | (marballsheepvisitsday$Var1 == "BHS_1581") | (marballsheepvisitsday$Var1 == "BHS_1577") | (marballsheepvisitsday$Var1 == "BHS_1574") | (marballsheepvisitsday$Var1 == "BHS_1576") | (marballsheepvisitsday$Var1 == "BHS_1583") | (marballsheepvisitsday$Var1 == "BHS_1584") | (marballsheepvisitsday$Var1 == "BHS_1585") | (marballsheepvisitsday$Var1 == "BHS_1587") | (marballsheepvisitsday$Var1 == "BHS_1582") | (marballsheepvisitsday$Var1 == "BHS_1575") | (marballsheepvisitsday$Var1 == "BHS_1592") | (marballsheepvisitsday$Var1 == "BHS_1594") | (marballsheepvisitsday$Var1 == "BHS_1420") | (marballsheepvisitsday$Var1 == "BHS_1493") | (marballsheepvisitsday$Var1 == "BHS_1494") | (marballsheepvisitsday$Var1 == "BHS_1590") | (marballsheepvisitsday$Var1 == "BHS_1591") | (marballsheepvisitsday$Var1 == "BHS_1682") | (marballsheepvisitsday$Var1 == "BHS_1683") | (marballsheepvisitsday$Var1 == "BHS_1684") | (marballsheepvisitsday$Var1 == "BHS_1366") | (marballsheepvisitsday$Var1 == "BHS_1497") | (marballsheepvisitsday$Var1 == "BHS_1588") | (marballsheepvisitsday$Var1 == "BHS_1595") | (marballsheepvisitsday$Var1 == "BHS_1589"), ]
sbrssheepvisitsdaymove <- sbrssheepvisitsday[(sbrssheepvisitsday$Var1 == "BHS_1330") | (sbrssheepvisitsday$Var1 == "BHS_1337") | (sbrssheepvisitsday$Var1 == "BHS_1334") | (sbrssheepvisitsday$Var1 == "BHS_1329") | (sbrssheepvisitsday$Var1 == "BHS_1328") | (sbrssheepvisitsday$Var1 == "BHS_1333") | (sbrssheepvisitsday$Var1 == "BHS_1425") | (sbrssheepvisitsday$Var1 == "BHS_1426") | (sbrssheepvisitsday$Var1 == "BHS_1489") | (sbrssheepvisitsday$Var1 == "BHS_1491") | (sbrssheepvisitsday$Var1 == "BHS_1578") | (sbrssheepvisitsday$Var1 == "BHS_1579") | (sbrssheepvisitsday$Var1 == "BHS_1580") | (sbrssheepvisitsday$Var1 == "BHS_1596") | (sbrssheepvisitsday$Var1 == "BHS_1599") | (sbrssheepvisitsday$Var1 == "BHS_1687") | (sbrssheepvisitsday$Var1 == "BHS_1486") | (sbrssheepvisitsday$Var1 == "BHS_1490") | (sbrssheepvisitsday$Var1 == "BHS_1492") | (sbrssheepvisitsday$Var1 == "BHS_1428") | (sbrssheepvisitsday$Var1 == "BHS_1685") | (sbrssheepvisitsday$Var1 == "BHS_1686") | (sbrssheepvisitsday$Var1 == "BHS_1688") | (sbrssheepvisitsday$Var1 == "BHS_1689"),]
nopaallsheepvisitsdaymove <- nopaallsheepvisitsday[(nopaallsheepvisitsday$Var1 == "BHS_1737") | (nopaallsheepvisitsday$Var1 == "BHS_1740") | (nopaallsheepvisitsday$Var1 == "BHS_1741") | (nopaallsheepvisitsday$Var1 == "BHS_1738") | (nopaallsheepvisitsday$Var1 == "BHS_1736") | (nopaallsheepvisitsday$Var1 == "BHS_1739"), ]
cmprallsheepvisitsdaymove <- cmprallsheepvisitsday[(cmprallsheepvisitsday$Var1 == "BHS_1730") | (cmprallsheepvisitsday$Var1 == "BHS_1733") | (cmprallsheepvisitsday$Var1 == "BHS_1734") | (cmprallsheepvisitsday$Var1 == "BHS_1728"), ]
alldaymove <- rbind(marballsheepvisitsdaymove, sbrssheepvisitsdaymove, nopaallsheepvisitsdaymove, cmprallsheepvisitsdaymove)
names(alldaymove)[names(alldaymove) == "Var1"] <- "BHSID"
names(alldaymove)[names(alldaymove) == "Var2"] <- "Date"
names(alldaymove)[names(alldaymove) == "Freq"] <- "NumVTW"
dailymeanstplength$BHSID <- as.factor(dailymeanstplength$BHSID)
stplengthvisit <- merge(dailymeanstplength, alldaymove, by = c("Date", "BHSID"))
stplengthvisit$Date <- as.Date(stplengthvisit$Date, format = "%Y-%m-%d")
plot(NumVTW ~ MeanTopoMoveHour, data = stplengthvisit)


```
8/28/20 Seeing the percent of sheep days when a sheep was recorded within 500 m of a water source and the temperature is over 35 degrees celsius that it actually visited a water source




```{r}
stepturndistallmtn4 <- stepturndistallmtn3
stepturndistallmtn4$IDDate <- paste(stepturndistallmtn4$BHSID, stepturndistallmtn4$Date, sep = "_")
probdrpt <- as.data.frame(table(stepturndistallmtn4$IDDate))
# Whether the sheep drank that day
allrangetime1$GO_Date <- as.Date(allrangetime1$GO_Date)
stepturndistallmtn4$dayofvisit <- FALSE
for(row in 1:nrow(allrangetime1)){
  sheep_id <- as.character(allrangetime1$KI_Known_ID[row])
  drink_time <- allrangetime1$GO_Date[row]
  ssheep_idxs <- which(stepturndistallmtn4$ID == sheep_id)
  ddrink_idx <- which(stepturndistallmtn4$Date == drink_time)
  rowswhendrink <- intersect(ssheep_idxs, ddrink_idx)
  stepturndistallmtn4$dayofvisit[rowswhendrink] <- TRUE
}
probdrpt$Var1 <- as.character(probdrpt$Var1)
probdrpt$visitthatday <- FALSE
onlyvisitthatday <- stepturndistallmtn4[stepturndistallmtn4$dayofvisit == TRUE, ]
for(row in 1:nrow(onlyvisitthatday)){
  sheepday <- as.character(onlyvisitthatday$IDDate[row])
  sheepday_idxs <- which(probdrpt$Var1 == sheepday)
  probdrpt$visitthatday[sheepday_idxs] <- TRUE
}
# TRUE = sheep drank that day
# FALSE = sheep didn't drink that day

# Temperature over 35 degrees Celsius
probdrpt$temp35 <- FALSE
tempover <- stepturndistallmtn4[stepturndistallmtn4$tmax..deg.c. >= 35, ]
for(row in 1:nrow(tempover)){
  hiha <- as.character(tempover$IDDate[row])
  hiha_idxs <- which(probdrpt$Var1 == hiha)
  probdrpt$temp35[hiha_idxs] <- TRUE
}
# Distance
  library(data.table)
holla <- data.table(stepturndistallmtn4)
attempt <- holla[ , .SD[which.min(Closedist)], by = IDDate]
# Between 500m and 1000m 
probdrpt$dist1000 <- FALSE
dist1000 <- attempt[((attempt$Closedist < 1000) & (attempt$Closedist >= 500)), ]
for(row in 1:nrow(dist1000)){
  hoho <- as.character(dist1000$IDDate[row])
  hoho_idxs <- which(probdrpt$Var1 == hoho)
  probdrpt$dist1000[hoho_idxs] <- TRUE
}
# Distance <= 500 m
probdrpt$dist500 <- FALSE
dist500 <- attempt[attempt$Closedist < 500, ]
for(row in 1:nrow(dist500)){
  hehe <- as.character(dist500$IDDate[row])
  hehe_idxs <- which(probdrpt$Var1 == hehe)
  probdrpt$dist500[hehe_idxs] <- TRUE
}



table(probdrpt$dist1000)
#FALSE  TRUE 
#  658    86 
table(probdrpt$dist500)
#FALSE  TRUE 
#  461   283 
nrow(probdrpt[((probdrpt$temp35 == TRUE) & (probdrpt$dist1000 == TRUE)), ])
# 49
nrow(probdrpt[((probdrpt$temp35 == TRUE) & (probdrpt$dist1000 == TRUE) & (probdrpt$visitthatday == TRUE)), ])
# 12
# 12/49
# 0.244898
nrow(probdrpt[((probdrpt$temp35 == TRUE) & (probdrpt$dist500 == TRUE)), ])
# 255
nrow(probdrpt[((probdrpt$temp35 == TRUE) & (probdrpt$dist500 == TRUE) & (probdrpt$visitthatday == TRUE)), ])
# 228
# 228/255
# 0.8941176





 # stepturndistallmtn2$beforevisit <- FALSE
# for(row in 1:nrow(allrangetime1)){
#  sheep_id <- as.character(allrangetime1$KI_Known_ID[row])
 # drink_time <- allrangetime1$DateTimect[row]
#  sheep_idxs <- which(stepturndistallmtn2$ID == sheep_id)
 # drink_idx <- which((stepturndistallmtn2$DateTimeLocalTestct < as.Date(drink_time)) & (stepturndistallmtn2$DateTimeLocalTestct >= as.Date(drink_time - 3900)))
#rowsbeforedrink <- intersect(sheep_idxs, drink_idx)
#stepturndistallmtn2$beforevisit[rowsbeforedrink] <- TRUE
#  }

# Whether the sheep drank that day
# probdrpt$Var1 <- as.character(probdrpt$Var1)
# probdrpt$visitthatday <- FALSE
# for(row in 1:nrow(stepturndistallmtn4)){
#  sheepday <- as.character(stepturndistallmtn4$IDDate[row])
 # yesvisit <- stepturndistallmtn4$beforevisit[row]
  #sheepday_idxs <- which(probdrpt$Var1 == sheepday)
#  yesvisit_idx <- which(yesvisit == TRUE)
#  rowsIDDatevisit <- intersect(sheepday_idxs, yesvisit_idx)
#  probdrpt$visitthatday[rowsIDDatevisit] <- TRUE
#}


```
Recalculating the turning angle relative to water 10/22/2020

**** In this section, I need to calculate lag and subset for only the ones that are between 50-70 mins apart.
```{r Recalculating turning angle relative to water}
# Making it a different dataframe so don't mess up anything
library(dplyr)
library(amt)
astepturndistallmtn2 <- stepturndistallmtn2
# astepturndistallmtn2$birdflydisttowater
astepturndistallmtn2$laggeostplfthpostclean <- lag(astepturndistallmtn2$geostplgthpostclean)
astepturndistallmtn2$laggeostplfthpostclean[astepturndistallmtn2$ID != lag(astepturndistallmtn2$ID)] <- NA
astepturndistallmtn2$leadbirdflydisttowater <- lag(astepturndistallmtn2$birdflydisttowater)
astepturndistallmtn2$leadbirdflydisttowater[(astepturndistallmtn2$ID != lag(astepturndistallmtn2$ID)) | (astepturndistallmtn2$WhichClose != lag(astepturndistallmtn2$WhichClose))] <- NA
# Calculating turning angle relative to water
astepturndistallmtn2$angle2water2 <- acos((((astepturndistallmtn2$leadbirdflydisttowater)^2) - ((astepturndistallmtn2$laggeostplfthpostclean)^2) - ((astepturndistallmtn2$birdflydisttowater)^2)) / (-2 * (astepturndistallmtn2$laggeostplfthpostclean) * (astepturndistallmtn2$birdflydisttowater)))
astepturndistallmtn2$angle2water2degree <- as_degree(astepturndistallmtn2$angle2water2)
# eliminating turning angles where it was not 1 step length away
library(dplyr)
astepturndistallmtn2$lagtime2 <- (astepturndistallmtn2$DateTimeLocalTestct - lag(astepturndistallmtn2$DateTimeLocalTestct))
astepturndistallmtn2$angle2water2degree[((astepturndistallmtn2$lagtime2 < 50) | (astepturndistallmtn2$lagtime2 > 70))] <- NA


# Seeing if there is a correlation between angle of movement relative to water and distance to water
plot(astepturndistallmtn2$Closedist ~ astepturndistallmtn2$angle2water2degree)
# No correlation

# GLM Incorrect
amovevisitglm <- glm(beforevisit ~ positangledegree + sqrt(stplengthtopo) + sqrt(Closedist) + angle2water2degree, data = astepturndistallmtn2, family = "binomial")
summary(amovevisitglm)

amovevisitglm1 <- glm(beforevisit ~ sqrt(stplengthtopo) + sqrt(Closedist) + angle2water2degree, data = astepturndistallmtn2, family = "binomial")
summary(amovevisitglm1)

amovevisitglm2 <- glm(beforevisit ~ sqrt(Closedist) + angle2water2degree, data = astepturndistallmtn2, family = "binomial")
summary(amovevisitglm2)

amovevisitglm3 <- glm(beforevisit ~ sqrt(Closedist), data = astepturndistallmtn2, family = "binomial")
summary(amovevisitglm3)
plot(amovevisitglm3)

#Linear Mixed Model Correct
library(lme4)
library(car)
astepturndistallmtn2a <- astepturndistallmtn2
astepturndistallmtn2a$Date <- as.factor(astepturndistallmtn2a$Date)
# Scaling independent variables - scaling is done by dividing the centered columns of x by their standard deviations. If put center as false, then would divide by root mean square
# https://stackoverflow.com/questions/20256028/understanding-scale-in-r
# allenvvisit1$scaledayl <- scale(allenvvisit1$dayl..s., center = TRUE, scale = TRUE)
astepturndistallmtn2a$scalepositangledegree <- scale(astepturndistallmtn2a$positangledegree, center = TRUE, scale = TRUE)
astepturndistallmtn2a$scalestplengthtopo <- scale(astepturndistallmtn2a$stplengthtopo, center = TRUE, scale = TRUE)
astepturndistallmtn2a$scaleClosedist <- scale(astepturndistallmtn2a$Closedist, center = TRUE, scale = TRUE)
astepturndistallmtn2a$scaleangle2water2degree <- scale(astepturndistallmtn2a$angle2water2degree, center = TRUE, scale = TRUE)
amovevizscal <- glmer(beforevisit ~ scalepositangledegree + scalestplengthtopo + scaleClosedist + scaleangle2water2degree + (1|Date) + (1|ID), data = astepturndistallmtn2a, family = binomial(link = "logit"))
summary(amovevizscal)
# Just curious without scale, says need to rescale, also only Closedist significant
quest <- glmer(beforevisit ~ positangledegree + stplengthtopo + Closedist + angle2water2degree + (1|Date) + (1|ID), data = astepturndistallmtn2a, family = binomial(link = "logit"))
summary(quest)
# Rescaled deleting scaleangle2water2degree
amovevizscal1 <- glmer(beforevisit ~ scalepositangledegree + scalestplengthtopo + scaleClosedist + (1|Date) + (1|ID), data = astepturndistallmtn2a, family = binomial(link = "logit"))
summary(amovevizscal1)
# Rescaled deleting scalstplengthtopo
amovevizscal2 <- glmer(beforevisit ~ scalepositangledegree + scaleClosedist + (1|Date) + (1|ID), data = astepturndistallmtn2a, family = binomial(link = "logit"))
summary(amovevizscal2)
# Rescaled deleting scalepositangledegree - THIS IS THE FINAL ONE YOU SHOULD USE FOR 1 HR FIX RATE!!!!! - 10/26/20
amovevizscal3 <- glmer(beforevisit ~ scaleClosedist + (1|Date) + (1|ID), data = astepturndistallmtn2a, family = binomial(link = "logit"))
summary(amovevizscal3)

# Fixed 10/28/20 # Error in 1 hr- should do eliminate the greater than four hours or wrong time scales after calculate all 4 variables... So my recalculated turning angle relative to water is still messed up b/c it does not account for the fact that it might be greater than 1 hour (btwn 50-70 mins) for some geometric step lengths that I re-calculated
```
analyzing if movement is different before water with 20 minute fix rate

Here are the sheep with 20 mins fix rate:
Marb BHS_1577 Ewe start:6/18/2019 21:00 end: 7/23/2019 11:00
- NROM BHS_1564 Ewe
- BrsS BHS_1580 Ewe Start: 7/24/2019 4:00, end: 8/11/2019 8:00
- Marb 1683 Ram Start: 7/23/2019 14:00, end: 8/9/2019 20:40
- CMPR BHS_1730 Ewe Start: 7/30/2019 21:00, end: 8/14/19 20:40
- Nopa BHS_1739 Ram Start: 7/23/2019 12:00, end: 8/6/2019 20:40


```{r}
# View(allidgpsdatacut3)
# allidgpsdatacut3 already cut to time with camera coverage
allidgpsdatacut4 <- allidgpsdatacut3[with(allidgpsdatacut3, order(KI_Known_ID, DateTimeLocalTestct)), ]
twemin <- allidgpsdatacut4[(allidgpsdatacut4$KI_Known_ID == "BHS_1577") |  (allidgpsdatacut4$KI_Known_ID == "BHS_1580") | (allidgpsdatacut4$KI_Known_ID == "BHS_1683") | (allidgpsdatacut4$KI_Known_ID == "BHS_1730") | (allidgpsdatacut4$KI_Known_ID == "BHS_1739"), ]
# Cutting to just the 20 minute time period
bhs1577 <- twemin[twemin$KI_Known_ID == "BHS_1577", ]
bhs1577cut <- bhs1577[(bhs1577$DateTimeLocalTestct >= as.POSIXct("2019-06-18 21:00") & bhs1577$DateTimeLocalTestct <= as.POSIXct("2019-07-23 11:00")), ]
bhs1580 <- twemin[twemin$KI_Known_ID == "BHS_1580", ]
bhs1580cut <- bhs1580[(bhs1580$DateTimeLocalTestct >= as.POSIXct("2019-07-24 04:00") & bhs1580$DateTimeLocalTestct <= as.POSIXct("2019-08-11 08:00")), ]
bhs1683 <- twemin[twemin$KI_Known_ID == "BHS_1683", ]
bhs1683cut <- bhs1683[(bhs1683$DateTimeLocalTestct >= as.POSIXct("2019-07-23 14:00") & bhs1683$DateTimeLocalTestct <= as.POSIXct("2019-08-09 20:40")), ]
bhs1730 <- twemin[twemin$KI_Known_ID == "BHS_1730", ]
bhs1730cut <- bhs1730[(bhs1730$DateTimeLocalTestct >= as.POSIXct("2019-07-30 21:00") & bhs1730$DateTimeLocalTestct <= as.POSIXct("2019-08-14 20:40")), ]
bhs1739 <- twemin[twemin$KI_Known_ID == "BHS_1739", ]
bhs1739cut <- bhs1739[(bhs1739$DateTimeLocalTestct >= as.POSIXct("2019-07-23 12:00") & bhs1739$DateTimeLocalTestct <= as.POSIXct("2019-08-06 20:40")), ]
# Cleaning GPS Points

#Elevation Cleaning
# To keep with the 1 hour methodology, I cleaned it by mountain ranges.
# Marbles
tweminmarb <- rbind(bhs1577cut, bhs1683cut)
nrow(tweminmarb)
#1676 points
tweminmarbalt <- tweminmarb[(tweminmarb$Altitude >= 181) & (tweminmarb$Altitude <= 1171), ]
nrow(tweminmarbalt)
# now 1638 points
#South Bristols
nrow(bhs1580cut)
# 721 points
bhs1580cutalt <- bhs1580cut[(bhs1580cut$Altitude >= 214) & (bhs1580cut$Altitude <= 997), ]
nrow(bhs1580cutalt)
# now 662 points
# CMPR
nrow(bhs1730cut)
# 925 points
bhs1730cutalt <- bhs1730cut[(bhs1730cut$Altitude >= 1219) & (bhs1730cut$Altitude <= 1580), ]
nrow(bhs1730cutalt)
# 914 points
# Nopah
nrow(bhs1739cut)
#917 points
bhs1739cutalt <- bhs1739cut[(bhs1739cut$Altitude >= 424) & (bhs1739cut$Altitude <= 1599), ]
nrow(bhs1739cutalt)
#861 points

# DOP Cleaning
# Marbles
tweminmarbaltdop <- tweminmarbalt[tweminmarbalt$DOP <= 10, ]
nrow(tweminmarbaltdop)
#1634 points
# South Bristols
bhs1580cutaltdop <- bhs1580cutalt[bhs1580cutalt$DOP <= 10, ]
nrow(bhs1580cutaltdop)
# 658  points
# CMPR
bhs1730cutaltdop <- bhs1730cutalt[bhs1730cutalt$DOP <= 10, ]
nrow(bhs1730cutaltdop)
#906 points
# Nopah
bhs1739cutaltdop <- bhs1739cutalt[bhs1739cutalt$DOP <= 10, ]
nrow(bhs1739cutaltdop)
# 855 points

# Topographic bias
# Total number of points that there should be over the time duration with 20 minute fixes was calculated separately. See Water Manipulation Google Doc
# Marbles
# 1634 / 3736 = 43.74%
# South Bristols
# 658 / 1309 = 50.27%
# CMPR
# 906/ 1080 = 83.89%
# Nopah
# 855/1035 = 82.61%
# unacceptable topographic bias in the Marbles and South Bristols at this fix rate

tweminallrange <- rbind(tweminmarbaltdop, bhs1580cutaltdop, bhs1730cutaltdop, bhs1739cutaltdop)

# Calculating turning angle
library(moveHMM)
ptweminallrange <- prepData(tweminallrange, type = "LL", coordNames = c("Longitude", "Latitude"))
ptweminallrange$positangle <- abs(ptweminallrange$angle) 
library(amt)
library(dplyr)
ptweminallrange$positangledegree <- as_degree(ptweminallrange$positangle)
ptweminallrange$lagtime <- (shift(ptweminallrange$DateTimeLocalTestct, n = 1) - ptweminallrange$DateTimeLocalTestct)
ptweminallrange$leadtime <- (ptweminallrange$DateTimeLocalTestct - (lag(ptweminallrange$DateTimeLocalTestct)))
ptweminallrange$lagtime <- as.numeric(ptweminallrange$lagtime)
ptweminallrange$leadtime <- as.numeric(ptweminallrange$leadtime)
ptweminallrange1 <- cbind(rownames(ptweminallrange), data.frame(ptweminallrange, row.names = NULL))
ptweminallrange2 <- ptweminallrange1[, 3:28]
ptweminallrange2[1146, 25] <- NA
ptweminallrange2[1147, 26] <- NA
ptweminallrange2[1634, 25] <- NA
ptweminallrange2[1635, 26] <- NA
ptweminallrange2[2292, 25] <- NA
ptweminallrange2[2293, 26] <- NA
ptweminallrange2[3198, 25] <- NA
ptweminallrange2[3199, 26] <- NA

# Calculating topographic step length:
# Nopah
library(raster, sp, rgdal)
bhs1739cutaltdopr <- ptweminallrange2[ptweminallrange2$MountainRange == "Nopa", ]
bhs1739cutaltdopy <- bhs1739cutaltdopr[2:813, ]
nopahelevationlol <- raster("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/output_srtmNopahElevation4520.tif")
twecoords1739 <- as.data.frame(bhs1739cutaltdopy[ ,c("x", "y")])
twerestodata1739 <- as.data.frame(bhs1739cutaltdopy[ ,c(1:2, 5:26)])
twenopa1739spdf <- SpatialPointsDataFrame(coords = twecoords1739, data = twerestodata1739, proj4string = crsnopa)
library(topoDistance)
twetopodistnopa1739 <- topoDist(DEM = nopahelevationlol, pts = twenopa1739spdf, directions = 8, paths = FALSE, zweight = 1)
twetopodistnopa17391 <- as.matrix(twetopodistnopa1739)
twetopodistnopa17391sub <- twetopodistnopa17391[row(twetopodistnopa17391) == (col(twetopodistnopa17391) -1)]
natwetopodistnopa17391sub <- c(NA, twetopodistnopa17391sub)
bhs1739cutaltdopy1 <- cbind(bhs1739cutaltdopy, natwetopodistnopa17391sub)

# CMPR
elevationcmpr <- raster("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/castlepiuteelevation.tif")
twecmpr1730 <- ptweminallrange2[ptweminallrange2$MountainRange == "CMPR", ]
twecmpr17301 <- twecmpr1730[1:886, ]
twecoords1730 <- as.data.frame(twecmpr17301[ ,c("x", "y")])
restodatatwe1730 <- as.data.frame(twecmpr17301[ ,c(1:2, 5:26)])
twecmprspdf <- SpatialPointsDataFrame(coords = twecoords1730, data = restodatatwe1730, proj4string = crscmpr)
topodisttwecmpr <- topoDist(DEM = elevationcmpr, pts = twecmprspdf, directions = 8, paths = FALSE, zweight = 1)
topodisttwecmpr1 <- as.matrix(topodisttwecmpr)
topodisttwecmprsub <- topodisttwecmpr1[row(topodisttwecmpr1) == (col(topodisttwecmpr1) - 1)]
natopodisttwecmpr1sub <- c(NA, topodisttwecmprsub)
twecmpr17302 <- cbind(twecmpr17301, natopodisttwecmpr1sub)

# Marbles
marbanotherelevation <- raster("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/Marbelevation41920.tif")
twemarb <- ptweminallrange2[ptweminallrange2$MountainRange == "Marb", ]
twemarb1 <- twemarb[1:1595, ]
twecoordsmarb <- as.data.frame(twemarb1[ ,c("x", "y")])
restoddatatwemarb <- as.data.frame(twemarb1[ ,c(1:2, 5:26)])
twemarbspdf <- SpatialPointsDataFrame(coords = twecoordsmarb, data = restoddatatwemarb, proj4string = crsmarb)
topodisttwemarb <- topoDist(DEM = marbanotherelevation, pts = twemarbspdf, directions = 8, paths = FALSE, zweight = 1)
topodisttwemarb1 <- as.matrix(topodisttwemarb)
topodisttwemarbsub <- topodisttwemarb1[row(topodisttwemarb1) == (col(topodisttwemarb1) - 1)]
natopodisttwemarbsub <- c(NA, topodisttwemarbsub)
twemarb2 <- cbind(twemarb1, natopodisttwemarbsub)
twemarb2[1146, 27] <- NA

# South Bristols
sbrselevation <- raster("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/SBrselevationattempt4.tif")
twesbrs <- ptweminallrange2[ptweminallrange2$MountainRange == "BrsS", ]
twecoordsbrs <- as.data.frame(twesbrs[ ,c("x", "y")])
restodatatwesbrs <- as.data.frame(twesbrs[ ,c(1:2, 5:26)])
crsbrs <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
twesbrspdf <- SpatialPointsDataFrame(coords = twecoordsbrs, data = restodatatwesbrs, proj4string = crsbrs)
library(topoDistance)
topodisttwesbrs <- topoDist(DEM = sbrselevation, pts = twesbrspdf, directions = 8, paths = FALSE, zweight = 1)
topodisttwesbrs1 <- as.matrix(topodisttwesbrs)
topodisttwesbrssub <- topodisttwesbrs1[row(topodisttwesbrs1) == (col(topodisttwesbrs1) - 1)]
natopodisttwesbrssub <- c(NA, topodisttwesbrssub)
twesbrs1 <- cbind(twesbrs, natopodisttwesbrssub)

# Combining all 4 mtn ranges
# names(rangeidhour)[names(rangeidhour) == "KI_Known_ID"] <- "ID"
names(bhs1739cutaltdopy1)[names(bhs1739cutaltdopy1) == "natwetopodistnopa17391sub"] <- "stplengthtopo"
names(twecmpr17302)[names(twecmpr17302) == "natopodisttwecmpr1sub"] <- "stplengthtopo"
names(twemarb2)[names(twemarb2) == "natopodisttwemarbsub"] <- "stplengthtopo"
names(twesbrs1)[names(twesbrs1) == "natopodisttwesbrssub"] <- "stplengthtopo"
ptweminallrange3 <- rbind(bhs1739cutaltdopy1, twecmpr17302, twemarb2, twesbrs1)
ptweminallrange4 <- ptweminallrange3[(((ptweminallrange3$lagtime >= 17 & ptweminallrange3$lagtime <= 23) | (is.na(ptweminallrange3$lagtime) == TRUE)) & ((ptweminallrange3$leadtime >= 17 & ptweminallrange3$leadtime <= 23) | (is.na(ptweminallrange3$leadtime) == TRUE))), ]

# Calculating topographic distance to the nearest water source
# Nopah
library(raster)
library(sp)
library(rgdal)
# nopah elevation = nopahelevationlol
ptweminallrange4$WaterSource <- NA
tweNopahWater <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/tweNopahWater.csv")
itwennopa <- ptweminallrange4[ptweminallrange4$MountainRange == "Nopa", ]
twenopawatergps <- rbind(tweNopahWater, itwennopa)
twenopawatergps$KI_Known_ID <- as.factor(twenopawatergps$KI_Known_ID)
itwenopacoords <- as.data.frame(twenopawatergps[ ,c("x", "y")])
itwenoparestodata <- as.data.frame(twenopawatergps[ ,c(1:2, 5:28)])
# crsnopa = coordinate system
itwespdfnopa <- SpatialPointsDataFrame(coords = itwenopacoords, data = itwenoparestodata, proj4string = crsnopa)
library(topoDistance)
itwenopatopodist <- topoDist(DEM = nopahelevationlol, pts = itwespdfnopa, directions = 8, paths = FALSE, zweight = 1)
itwenopatopodist1 <- itwenopatopodist[, c(1:3)]
itwenopatopodist1 <- as.data.frame(itwenopatopodist1)
names(itwenopatopodist1)[names(itwenopatopodist1) == "1"] <- "ElSi"
names(itwenopatopodist1)[names(itwenopatopodist1) == "2"] <- "Nopa"
names(itwenopatopodist1)[names(itwenopatopodist1) == "3"] <- "SNop"
itwenopatopodist1$WhichClose <- colnames(itwenopatopodist1)[apply(itwenopatopodist1, 1, which.min)]
itwenopatopodist1$Closedist <- pmin(itwenopatopodist1$ElSi, itwenopatopodist1$Nopa, itwenopatopodist1$SNop)
itwenopatopodist2 <- itwenopatopodist1[-c(1, 2, 3), ]
itwennopawat <- cbind(itwennopa, itwenopatopodist2[, 4:5, drop = FALSE])

# Castle Piutes
# elevationcmpr
tweCMPRwater <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/twecmprwatersources.csv")
itwencmpr <- ptweminallrange4[ptweminallrange4$MountainRange == "CMPR", ]
twecmprwatergps <- rbind(tweCMPRwater, itwencmpr)
twecmprwatergps$KI_Known_ID <- as.factor(twecmprwatergps$KI_Known_ID)
itwecmprcoords <- as.data.frame(twecmprwatergps[ ,c("x", "y")])
itwecmprrestodata <- as.data.frame(twecmprwatergps[ ,c(1:2, 5:28)])
# crscmpr
itwecmprspdf <- SpatialPointsDataFrame(coords = itwecmprcoords, data = itwecmprrestodata, proj4string = crscmpr)
itwecmprtopodist <- topoDist(DEM = elevationcmpr, pts = itwecmprspdf, directions = 8, paths = FALSE, zweight = 1)
itwecmprtopodist1 <- itwecmprtopodist[, c(1:2)]
itwecmprtopodist1 <- as.data.frame(itwecmprtopodist1)
names(itwecmprtopodist1)[names(itwecmprtopodist1) == "1"] <- "Vice"
names(itwecmprtopodist1)[names(itwecmprtopodist1) == "2"] <- "KidS"
itwecmprtopodist1$WhichClose <- colnames(itwecmprtopodist1)[apply(itwecmprtopodist1, 1, which.min)]
itwecmprtopodist1$Closedist <- pmin(itwecmprtopodist1$Vice, itwecmprtopodist1$KidS)
itwecmprtopodist2 <- itwecmprtopodist1[-c(1, 2), ]
itwecmprwat <- cbind(itwencmpr, itwecmprtopodist2[ , 3:4, drop = FALSE])

# Marbles
marbanotherelevation <- raster("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/Marbelevation41920.tif")
itwenmarb <- ptweminallrange4[ptweminallrange4$MountainRange == "Marb", ]
# all of the observations are after 5/30
twemarbwater <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/twemarbwatersources.csv")
twemarbwatergps <- rbind(twemarbwater, itwenmarb)
twemarbwatergps$KI_Known_ID <- as.factor(twemarbwatergps$KI_Known_ID)
itwemarbcoords <- as.data.frame(twemarbwatergps[ ,c("x", "y")])
itwemarbrestodata <- as.data.frame(twemarbwatergps[ ,c(1:2, 5:28)])
# crsmarb
itwemarbspdf <- SpatialPointsDataFrame(coords = itwemarbcoords, data = itwemarbrestodata, proj4string = crsmarb)
itwemarbtopodist <- topoDist(DEM = marbanotherelevation, pts = itwemarbspdf, directions = 8, paths = FALSE, zweight = 1)
itwemarbtopodist1 <- itwemarbtopodist[, c(1:4)]
itwemarbtopodist1 <- as.data.frame(itwemarbtopodist1)
names(itwemarbtopodist1)[names(itwemarbtopodist1) == "1"] <- "SI40"
names(itwemarbtopodist1)[names(itwemarbtopodist1) == "2"] <- "Ther"
names(itwemarbtopodist1)[names(itwemarbtopodist1) == "3"] <- "Vern"
names(itwemarbtopodist1)[names(itwemarbtopodist1) == "4"] <- "DevS"
itwemarbtopodist1$WhichClose <- colnames(itwemarbtopodist1)[apply(itwemarbtopodist1, 1, which.min)]
itwemarbtopodist1$Closedist <- pmin(itwemarbtopodist1$SI40, itwemarbtopodist1$Ther, itwemarbtopodist1$Vern, itwemarbtopodist1$DevS)
itwemarbtopodist2 <- itwemarbtopodist1[-c(1, 2, 3, 4), ]
itwemarbwat <- cbind(itwenmarb, itwemarbtopodist2[ , 5:6, drop = FALSE])

# South Bristols
sbrselevation <- raster("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/SBrselevationattempt4.tif")
itwesbrs <- ptweminallrange4[ptweminallrange4$MountainRange == "BrsS", ]
# Covers 7/24 and 7/25+after time periods
itwesbrs724 <- itwesbrs[itwesbrs$DateTimeLocalTestct <= as.POSIXct("2019-07-24 23:59:59"), ]
itwesbrsrest <- itwesbrs[itwesbrs$DateTimeLocalTestct >= as.POSIXct("2019-07-25 00:00:00"), ]
twe724sbrswater <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/twesbrs724watersources.csv")
twerestsbrswater <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/twesbrs725afterwatersources.csv")
#7/24
twesbrswatergps724 <- rbind(twe724sbrswater, itwesbrs724)
twesbrswatergps724$KI_Known_ID <- as.factor(twesbrswatergps724$KI_Known_ID)
itwesbrscoords724 <- as.data.frame(twesbrswatergps724[ ,c("x", "y")])
itwesbrsrestodata724 <- as.data.frame(twesbrswatergps724[ ,c(1:2, 5:28)])
# crssbrs
itwesbrspdf724 <- SpatialPointsDataFrame(coords = itwesbrscoords724, data = itwesbrsrestodata724, proj4string = crssbrs)
itwesbrstopodist724 <- topoDist(DEM = sbrselevation, pts = itwesbrspdf724, directions = 8, paths = FALSE, zweight = 1)
itwesbrstopodist7241 <- itwesbrstopodist724[, c(1:2)]
itwesbrstopodist7241 <- as.data.frame(itwesbrstopodist7241)
names(itwesbrstopodist7241)[names(itwesbrstopodist7241) == "1"] <- "MilC"
names(itwesbrstopodist7241)[names(itwesbrstopodist7241) == "2"] <- "Naan"
itwesbrstopodist7241$WhichClose <- colnames(itwesbrstopodist7241)[apply(itwesbrstopodist7241, 1, which.min)]
itwesbrstopodist7241$Closedist <- pmin(itwesbrstopodist7241$MilC, itwesbrstopodist7241$Naan)
itwesbrstopodist7242 <- itwesbrstopodist7241[-c(1, 2), ]
itwesbrs724wat <- cbind(itwesbrs724, itwesbrstopodist7242[, 3:4, drop = FALSE])
#7/25 and later
twesbrswatergpsrest <- rbind(twerestsbrswater, itwesbrsrest)
twesbrswatergpsrest$KI_Known_ID <- as.factor(twesbrswatergpsrest$KI_Known_ID)
itwesbrscoordsrest <- as.data.frame(twesbrswatergpsrest[ ,c("x", "y")])
itwesbrsrestodatarest <- as.data.frame(twesbrswatergpsrest[ ,c(1:2, 5:28)])
# crssbrs
itwesbrspdfrest <- SpatialPointsDataFrame(coords = itwesbrscoordsrest, data = itwesbrsrestodatarest, proj4string = crssbrs)
itwesbrstopodistrest <- topoDist(DEM = sbrselevation, pts = itwesbrspdfrest, directions = 8, paths = FALSE, zweight = 1)
itwesbrstopodistrest1 <- itwesbrstopodistrest[, c(1:3)]
itwesbrstopodistrest1 <- as.data.frame(itwesbrstopodistrest1)
names(itwesbrstopodistrest1)[names(itwesbrstopodistrest1) == "1"] <- "MilC"
names(itwesbrstopodistrest1)[names(itwesbrstopodistrest1) == "2"] <- "Naan"
names(itwesbrstopodistrest1)[names(itwesbrstopodistrest1) == "3"] <- "Talc"
itwesbrstopodistrest1$WhichClose <- colnames(itwesbrstopodistrest1)[apply(itwesbrstopodistrest1, 1, which.min)]
itwesbrstopodistrest1$Closedist <- pmin(itwesbrstopodistrest1$MilC, itwesbrstopodistrest1$Naan, itwesbrstopodistrest1$Talc)
itwesbrstopodistrest2 <- itwesbrstopodistrest1[-c(1, 2, 3), ]
itwesbrswatrest <- cbind(itwesbrsrest, itwesbrstopodistrest2[, 4:5, drop = FALSE])
itwesbrswat <- rbind(itwesbrs724wat, itwesbrswatrest)
# Combining all four mtn ranges
tweallmtndistwater <- rbind(itwennopawat, itwecmprwat, itwemarbwat, itwesbrswat)

# Calculating angle of movement relative to water
library(geosphere)
AllWater <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/Summer2019WaterSources.csv")
tweallmtndistwater1 <- merge(tweallmtndistwater, AllWater, by.x = "WhichClose", by.y = "WhichClose")
pA <- tweallmtndistwater1[, c(4, 5)]
pA <- as.matrix(pA)
pB <- tweallmtndistwater1[, c(32, 31)]
pB <- as.matrix(pB)
tweallmtndistwater1$birdflydisttowater <- distGeo(pA, pB)
tweallmtndistwater2 <- tweallmtndistwater1[with(tweallmtndistwater1, order(MountainRange, KI_Known_ID, DateTimeLocalTestct)), ]
library(dplyr)
tweallmtndistwater2$laglongitude <- lead(tweallmtndistwater2$x, n = 1)
tweallmtndistwater2$laglatitude <- lead(tweallmtndistwater2$y, n = 1)
apA <- tweallmtndistwater2[ ,c(4, 5)]
apA <- as.matrix(apA)
apB <- tweallmtndistwater2[ ,c(34, 35)]
apB <- as.matrix(apB)
tweallmtndistwater2$geostplgthpostclean <- distGeo(apA, apB)
shift <- function(x, n){
  c(x[-(seq(n))], rep(NA, n))
}
tweallmtndistwater2$lagbirdflydisttowater <- shift(tweallmtndistwater2$birdflydisttowater, 1)
tweallmtndistwater2$angletowater <- acos((((tweallmtndistwater2$lagbirdflydisttowater)^2) - ((tweallmtndistwater2$geostplgthpostclean)^2) - ((tweallmtndistwater2$birdflydisttowater)^2)) / (-2 * (tweallmtndistwater2$geostplgthpostclean) * (tweallmtndistwater2$birdflydisttowater)))
rownames(tweallmtndistwater2) <- 1:nrow(tweallmtndistwater2)
tweallmtndistwater2[c(572, 1422, 2526, 2943), 38] <- NA
library(amt)
library(dplyr)
tweallmtndistwater2$angletowaterdegree <- as_degree(tweallmtndistwater2$angletowater)

# To calculate whether an entry was right before water
library(lubridate)
tweallmtndistwater2$beforevisit <- FALSE

for(row in 1:nrow(allrangetime1)){
  sheep_id <- as.character(allrangetime1$KI_Known_ID[row])
  drink_time <- allrangetime1$DateTimect[row]
  sheep_idxs <- which(tweallmtndistwater2$ID == sheep_id)
  drink_idx <- which((tweallmtndistwater2$DateTimeLocalTestct < as.Date(drink_time)) & (tweallmtndistwater2$DateTimeLocalTestct >= as.Date(drink_time - 3900)))
  }
# Everything is false. Cannot complete analysis. Whelp.



stepturndistallmtn2$beforevisit <- FALSE
for(row in 1:nrow(allrangetime1)){
  sheep_id <- as.character(allrangetime1$KI_Known_ID[row])
  drink_time <- allrangetime1$DateTimect[row]
  sheep_idxs <- which(stepturndistallmtn2$ID == sheep_id)
  drink_idx <- which((stepturndistallmtn2$DateTimeLocalTestct < as.Date(drink_time)) & (stepturndistallmtn2$DateTimeLocalTestct >= as.Date(drink_time - 3900)))
rowsbeforedrink <- intersect(sheep_idxs, drink_idx)
stepturndistallmtn2$beforevisit[rowsbeforedrink] <- TRUE
  }

```
JUNK This code is what I used before I went into the lab and did it on a computer that could handle the topoDistance function.
```{r}
# Setting up the elevation raster
library(raster)
library(sp)
library(rgdal)
nopahelevation <- raster("C:/Users/Danielle Glass/Downloads/nopahelevation.tif")
proj4string(nopahelevation) <- CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs")
plot(nopahelevation, compact = TRUE)
library(rgdal)
# tnopahelevation <- projectRaster(from = nopahelevation, crs = ("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
# plot(tnopahelevation)
nopahelevationattempt2 <- raster("C:/Users/Danielle Glass/Downloads/NopahElevation1.tif")
proj4string(nopahelevationattempt2) <- CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs")

nopahelevationattempt3 <- raster("C:/Users/dmg85/Downloads/Sheepies3-master/output_srtm.tif")
# 
# Attempt below didn't work, but one above did?
# nopahelevationproj <- projectRaster(nopahelevation, crs = "+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs")

# WGS 84 

# Setting up the SpatialPointsObjects

# This step length calculated automatically from the prepData function of moveHMM does not account for geodetic (the earth being a sphere), or topopgraphy.
pcln1hrfix$stepnotopo <- (pcln1hrfix$step * 1000)

# This one does:
onehrnopah <- pcln1hrfix[pcln1hrfix$MountainRange == "Nopa", ]
onehrnopah$ID <- droplevels(onehrnopah$ID)
coordsnopa <- as.data.frame(onehrnopah[ ,c("x", "y")])
restodatanopa <- as.data.frame(onehrnopah[ , c(1:3, 6:27)])
crsnopa <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
# crsnopa <- CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs")
nopaspdf <- SpatialPointsDataFrame(coords = coordsnopa, data = restodatanopa, proj4string = crsnopa)
# tnopaspdf <- spTransform(nopaspdf , CRS("+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs"))
jpeg("tnopaspdf.jpg", width = 8, height = 12, units = "in", res = 180)
plot(tnopaspdf)
dev.off()
View(nopaspdf@data)

library(topoDistance)
topodistnopa <- topoDist(DEM = nopahelevationattempt2, pts = tnopaspdf, directions = 4, paths = FALSE, zweight = 1)
View(topodistnopa)
topodistnopa1 <- as.matrix(topodistnopa)
topodistnopa1sub <- topodistnopa1[row(topodistnopa1) == (col(topodistnopa1) - 1)]
View(topodistnopa1sub)
natopodistnopa1sub <- c(NA, topodistnopa1sub)

onehrnopah2 <- cbind(onehrnopah, natopodistnopa1sub)

write.csv(onehrnopah2, "C:/Users/Danielle Glass/Documents/RWorkingDirectory2/Sheepies3/pcln1hrfix3820.csv")
  #onehrnopah$topodistnopahstplength <- topodistnopa1sub

# hi
#View(onehrnopah2)


# library(dplyr)
# BrsSlongtimedif <- BrsScutobslong %>%
#   arrange(KI_Known_ID, DateTimect) %>%
#   group_by(KI_Known_ID) %>%
#   mutate(Timediff = DateTimect - lag(DateTimect), diff_hours = as.numeric(Timediff, units = 'hours'))

library(adehabitatLT)
data.lt.nopah <- as.ltraj(xy = onehrnopah[, c("x", "y")], date = onehrnopah$DateTimeLocalTestct, id = onehrnopah$ID)
View(data.lt.nopah[[1]])

# data.lt_Desert <- as.ltraj(xy = DesertDataDanielleNoDuplicates[, c("UTME", "UTMN")], date = DesertDataDanielleNoDuplicates$DateTimeC, id = DesertDataDanielleNoDuplicates$ID)

# data.lt<-as.ltraj(xy=data[,c("x","y")], date=data$date, id=data$id)





```
Reading in the step length incorporating topography csv. NEED TO WORK ON THIS.


```{r}
steplengthallmtn <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory2/Sheepies3/steplengthallmtn3820.csv")




```

```{r}
library(rosm)
library(prettymapr)

marbles <- makebbox(34.743890,-115.475526,34.521739,-115.699376)

# n, e, s, w
bmaps.plot(marbles, type = "Aerial", zoom = 10)


# sp package
# talk to Lorena

library(moveHMM)


# JUNK CODE FROM ATTEMPTS:
# ggmap(get_stamenmap(bbox = c(left = -115.656813, bottom = 34.648079, right = -115.471502, top = 34.639717), maptype = "terrain", crop = FALSE, zoom = 12))

# install.packages("devtools")
# install.packages("ggmap")
# library(ggmap)
# library(ggplot2)
# library("devtools")
# marblesbasemap <- get_map(location = c(lon = 115.582657, lat = 34.641645), zoom = 11, maptype = 'hybrid', source = 'stamen') 

# bbox <- c(left = 34.639717, bottom = 115.471502, right = 34.648079, top = 115.656813)
# ggmap(get_map(bbox, zoom = 13))

# bbox <- get_stamenmap(bbox = c(left = 34.639717, bottom = 115.471502, right = 34.648079, top = 115.656813), maptype = "terrain", crop = FALSE, zoom = 10)

# Attempt #2
# get_map(location = c(lon = -115.571137, lat = 34.636558), zoom = 10, scale = "auto", maptype = "terrain", source = "google")

```



```{r}
onehrnopah


# library(dplyr)
# BrsSlongtimedif <- BrsScutobslong %>%
#   arrange(KI_Known_ID, DateTimect) %>%
#   group_by(KI_Known_ID) %>%
#   mutate(Timediff = DateTimect - lag(DateTimect), diff_hours = as.numeric(Timediff, units = 'hours'))

library(adehabitatLT)
library(dplyr)
data.lt.nopah <- as.ltraj(xy = onehrnopah[, c("x", "y")], date = onehrnopah$DateTimeLocalTestct, id = onehrnopah$ID)
View(data.lt.nopah[[1]])
for(i in 1:3){data.lt.nopah[[i]]$xend <- lag(data.lt.nopah[[i]]$x)}
for(i in 1:3){data.lt.nopah[[i]]$yend <- lag(data.lt.nopah[[i]]$y)}
nopah1736 <- as.data.frame(data.lt.nopah[[1]])
write.csv(nopah1736, "C:/Users/Danielle Glass/Documents/RWorkingDirectory2/Sheepies3/nopah1736.csv")

# hi
```

