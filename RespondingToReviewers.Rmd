---
title: "RespondingToReviewers"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

balenvvisitnozero <- ballenvvisit2[ballenvvisit2$NumIndSheep != 0,]




library(pscl)
negbintwovar <- zeroinfl(NumIndSheep ~ tmax..deg.c. + MeanNDVI + tmin..deg.c. + prcp..mm.day. | tmax..deg.c. + MeanNDVI + tmin..deg.c. + prcp..mm.day. + MtnRange, data = ballenvvisit2, dist = "negbin", link = "logit")
summary(negbintwovar)
AIC(negbintwovar)
BIC(negbintwovar)
length(coefficients(negbintwovar))

negbintwovar1 <- zeroinfl(NumIndSheep ~ tmax..deg.c. + MeanNDVI + tmin..deg.c. | tmax..deg.c. + MeanNDVI + tmin..deg.c. + MtnRange, data = ballenvvisit2, dist = "negbin", link = "logit")
summary(negbintwovar1)
AIC(negbintwovar1)

negbintwovar2 <- zeroinfl(NumIndSheep ~ tmax..deg.c. + MeanNDVI | tmax..deg.c. + MeanNDVI + MtnRange, data = ballenvvisit2, dist = "negbin", link = "logit")
summary(negbintwovar2)
AIC(negbintwovar2)

negbintwovar2int <- zeroinfl(NumIndSheep ~ tmax..deg.c. + MeanNDVI + tmax..deg.c. * MeanNDVI | tmax..deg.c. + MeanNDVI + tmax..deg.c. * MeanNDVI + MtnRange, data = ballenvvisit2, dist = "negbin", link = "logit")
summary(negbintwovar2int)
# computationally singular

vuong(negbintwovar, twovar)
vuong(negbintwovar2, twovar1)

hurdtwovar <- hurdle(NumIndSheep ~ tmax..deg.c. + MeanNDVI + tmin..deg.c. + prcp..mm.day. | tmax..deg.c. + MeanNDVI + tmin..deg.c. + prcp..mm.day. + MtnRange, data = ballenvvisit2, dist = "poisson", link = "logit")
summary(hurdtwovar)

hurdtwovar1 <- hurdle(NumIndSheep ~ tmax..deg.c. + MeanNDVI + tmin..deg.c. | tmax..deg.c. + MeanNDVI + tmin..deg.c. + MtnRange, data = ballenvvisit2, dist = "poisson", link = "logit")
summary(hurdtwovar1)

vuong(twovar1, hurdtwovar1)

# From the Zuur book zero inflated chapter:
library(lmtest)
# these two models below have the same variable
lrtest(twovar1, negbintwovar1)

lrtest(negbintwovar1, twovar1)
lrtest(negbintwovar1, hurdtwovar1)


### Checking with 6 week precip 1/14/22
ballenvvisit4 <- ballenvvisit2
Precip6Wk <- read.csv("C:/Users/Danielle Glass/Documents/RWorkingDirectory3/Sheepies5/6WeekTotalPrecip.csv", sep = ",", header = TRUE)
ballenvvisitpre <- cbind(ballrangeenvvar, Precip6Wk$Week6TotalPrecip)
names(ballenvvisitpre)[names(ballenvvisitpre) == "MountainRange"] <- "MtnRange"
ballenvvisitpre1 <- merge(x = meanpercentbighorn2, y = ballenvvisitpre, all = TRUE)
ballenvvisitpre2 <- ballenvvisitpre1[with(ballenvvisitpre1, order(MtnRange, Date)), ]
ballenvvisitpre3 <- ballenvvisitpre2[complete.cases(ballenvvisitpre2), ]
names(ballenvvisitpre3)[names(ballenvvisitpre3) == "Precip6Wk$Week6TotalPrecip"] <- "Precip6Wk"

# Modeling
library(pscl)

# Model with tmax, NDVI, tmin, precip, 6Wk precip works
prmd <- zeroinfl(NumIndSheep ~ tmax..deg.c. + MeanNDVI + tmin..deg.c. + prcp..mm.day. + Precip6Wk | tmax..deg.c. + MeanNDVI + tmin..deg.c. + prcp..mm.day. + Precip6Wk + MtnRange, data = ballenvvisitpre3, dist = "negbin", link = "logit")
summary(prmd)
BIC(prmd)

# Minus precip
prmd1 <- zeroinfl(NumIndSheep ~ tmax..deg.c. + MeanNDVI + tmin..deg.c. + Precip6Wk | tmax..deg.c. + MeanNDVI + tmin..deg.c. + Precip6Wk + MtnRange, data = ballenvvisitpre3, dist = "negbin", link = "logit")
summary(prmd1)
BIC(prmd1)

# Minus tmin -- best model 1/14/22
marbv3 <- ballenvvisitpre3[ballenvvisitpre3$MtnRange == "Marb", ]
cmprv3 <- ballenvvisitpre3[ballenvvisitpre3$MtnRange == "CMPR", ]

prmd2 <- zeroinfl(NumIndSheep ~ tmax..deg.c. + MeanNDVI + Precip6Wk | tmax..deg.c. + MeanNDVI + Precip6Wk, data = cmprv3, dist = "negbin", link = "logit")
# + MtnRange
summary(prmd2)
AIC(prmd2)
BIC(prmd2)

# Including interaction btwn Precip6Wk and MeanNDVI -- best model as of 1/19/22***
prmdint <- zeroinfl(NumIndSheep ~ tmax..deg.c. + MeanNDVI + Precip6Wk + MeanNDVI * Precip6Wk | tmax..deg.c. + MeanNDVI + Precip6Wk + MeanNDVI * Precip6Wk + MtnRange, data = ballenvvisitpre3, dist = "negbin", link = "logit")
summary(prmdint)
AIC(prmdint)
BIC(prmdint)

# Including interaction btwn MeanNDVI + tmax
prmdint1 <- zeroinfl(NumIndSheep ~ tmax..deg.c. + MeanNDVI + Precip6Wk + MeanNDVI * tmax..deg.c. | tmax..deg.c. + MeanNDVI + Precip6Wk + MeanNDVI * tmax..deg.c. + MtnRange, data = ballenvvisitpre3, dist = "negbin", link = "logit")
summary(prmdint1)
AIC(prmdint1)
# Singular!


# Including interaction between tmax and Precip6Wk
prmdint2 <- zeroinfl(NumIndSheep ~ tmax..deg.c. + MeanNDVI + Precip6Wk + tmax..deg.c. * Precip6Wk | tmax..deg.c. + MeanNDVI + Precip6Wk + tmax..deg.c. * Precip6Wk + MtnRange, data = ballenvvisitpre3, dist = "negbin", link = "logit")
summary(prmdint2)
AIC(prmdint2)
BIC(prmdint2)
# Not as good an AIC, NaNs produced

# Interaction between tmax, ndvi, and Precip6Wk
prmdint3 <- zeroinfl(NumIndSheep ~ tmax..deg.c. + MeanNDVI + Precip6Wk + tmax..deg.c. * Precip6Wk * MeanNDVI | tmax..deg.c. + MeanNDVI + Precip6Wk + tmax..deg.c. * Precip6Wk * MeanNDVI + MtnRange, data = ballenvvisitpre3, dist = "negbin", link = "logit")
summary(prmdint3)
AIC(prmdint3)
# Computationally singular





# Comparing against poisson model
prmd2poi <- zeroinfl(NumIndSheep ~ tmax..deg.c. + MeanNDVI + Precip6Wk | tmax..deg.c. + MeanNDVI + Precip6Wk + MtnRange, data = ballenvvisitpre3, dist = "poisson", link = "logit")
summary(prmd2poi)
AIC(prmd2poi)

lrtest(prmd2, prmd2poi)
# Negative binomial is better

##Checking to make sure other variables are still computationally singular
prmds <- zeroinfl(NumIndSheep ~ srad..W.m.2. | srad..W.m.2. + MtnRange, data = ballenvvisitpre3, dist = "negbin", link = "logit")
summary(prmds)
# solar radiation computationally singular

# Day length
dyl <- zeroinfl(NumIndSheep ~ dayl..s. | dayl..s. + MtnRange, data = ballenvvisitpre3, dist = "negbin", link = "logit")
summary(dyl)

# Vapor Pressure
vp <- zeroinfl(NumIndSheep ~ vp..Pa. | vp..Pa. + MtnRange, data = ballenvvisitpre3, dist = "negbin", link = "logit")
summary(vp)
pR2(vp)

# Selecting Models
library(AICcmodavg)
models <- list(prmd, prmd1, prmd2, prmds, dyl, vp, prmdint, prmdint1, prmdint2, prmdint3)
model.names <- c('tmax.ndvi.tmin.precip.precip6.model', 'tmax.ndvi.tmin.precip6.model', 'tmax.ndvi.precip6.model', 'srad', 'dayl', 'vp', 'inter.prcp6.ndvi', 'inter.ndvi.tmax', 'inter.tmax.prcp6', 'inter.prcp6.ndvi.tmax')
aictab(cand.set = models, modnames = model.names)
bictab(cand.set = models, modnames = model.names)

# Only including models that are not computationally singular
models1 <- list(prmd, prmd1, prmd2, prmdint, prmdint2)
models.names1 <- c('tmax.ndvi.tmin.precip.precip6.model', 'tmax.ndvi.tmin.precip6.model', 'tmax.ndvi.precip6.model', 'inter.prcp6.ndvi', 'inter.tmax.prcp6') 
aictab(cand.set = models1, modnames = models.names1)
bictab(cand.set = models1, modnames = models.names1)

# Running the model with scaled variables to see which one has the biggest effect

scballpre3 <- ballenvvisitpre3
scballpre3$scaletmax <- scale(scballpre3$tmax..deg.c., center = TRUE, scale = TRUE)
scballpre3$scaleMeanNDVI <- scale(scballpre3$MeanNDVI, center = TRUE, scale = TRUE)
scballpre3$scaleprecip6wk <- scale(scballpre3$Precip6Wk, center = TRUE, scale = TRUE)

scaleprmd <- zeroinfl(NumIndSheep ~ scaletmax + scaleMeanNDVI + scaleprecip6wk | scaletmax + scaleMeanNDVI + scaleprecip6wk + MtnRange, data = scballpre3, dist = "negbin", link = "logit")
summary(scaleprmd)
pR2(scaleprmd)

## Double-Checking with GLMM adaptive
library(GLMMadaptive) 
jball3 <- ballenvvisitpre3
jball3$scaledayl <- scale(jball3$dayl..s., center = TRUE, scale = TRUE)
jball3$scaleprcp <- scale(jball3$prcp..mm.day., center = TRUE, scale = TRUE)
jball3$scalesrad <- scale(jball3$srad..W.m.2., center = TRUE, scale = TRUE)
jball3$scaletmax <- scale(jball3$tmax..deg.c., center = TRUE, scale = TRUE)
jball3$scaletmin <- scale(jball3$tmin..deg.c., center = TRUE, scale = TRUE)
jball3$scalevp <- scale(jball3$vp..Pa., center = TRUE, scale = TRUE)
jball3$scalendvi <- scale(jball3$MeanNDVI, center = TRUE, scale = TRUE)
jball3$scale6wkprecip <- scale(jball3$Precip6Wk, center = TRUE, scale = TRUE)

marbv3 <- ballenvvisitpre3[ballenvvisitpre3$MtnRange == "Marb", ]

adprmd2 <- mixed_model(NumIndSheep ~ tmax..deg.c. + MeanNDVI + Precip6Wk, data = marbv3, family = zi.negative.binomial(), zi_fixed = ~ tmax..deg.c. + MeanNDVI + Precip6Wk)
# , random = ~ 1 | MtnRange

adprmd2 <- mixed_model(NumIndSheep ~ tmax..deg.c. + MeanNDVI + Precip6Wk, random = ~ 1 | MtnRange, data = ballenvvisitpre3, family = zi.negative.binomial(), zi_fixed = ~ tmax..deg.c. + MeanNDVI + Precip6Wk)

adprmd2 <- mixed_model(NumIndSheep ~ scaletmax + scalendvi + scale6wkprecip, random = ~ 1 | MtnRange, data = jball3, family = zi.negative.binomial(), zi_fixed = ~ scaletmax + scalendvi + scale6wkprecip, control = 'iter_EM = 0')

## Double-checking with glmmTMB

library(glmmTMB)

prmd <- zeroinfl(NumIndSheep ~ tmax..deg.c. + MeanNDVI + tmin..deg.c. + prcp..mm.day. + Precip6Wk | tmax..deg.c. + MeanNDVI + tmin..deg.c. + prcp..mm.day. + Precip6Wk + MtnRange, data = ballenvvisitpre3, dist = "negbin", link = "logit")

cup <- glmmTMB(NumIndSheep ~ tmax..deg.c. + (1|MtnRange), zi = ~ tmax..deg.c., family = nbinom2, data = ballenvvisitpre3, control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))
summary(cup)
cup1 <- glmmTMB(NumIndSheep ~ tmax..deg.c. + (1|MtnRange), zi = ~ tmax..deg.c., family = nbinom2, data = ballenvvisitpre3, control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))
summary(cup1)
# tmax works
# mtnrange3 also works
anova(cup, cup1)
# Same equivalent so probably not including Mtn range in zero inflated is better

cuptmin <- glmmTMB(NumIndSheep ~ tmin..deg.c. + (1|MtnRange), zi = ~ tmin..deg.c., family = nbinom2, data = ballenvvisitpre3, control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))
# fits but can't produce AIC
#mtnrange3 doesn't converge

cupdl <- glmmTMB(NumIndSheep ~ dayl..s. + (1|MtnRange), zi = ~ dayl..s., family = nbinom2, data = ballenvvisitpre3, control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))
# NAN's produced
# mtnrange3 doens't converge

cupsr <- glmmTMB(NumIndSheep ~ srad..W.m.2. + (1|MtnRange), zi = ~ srad..W.m.2., family = nbinom2, data = ballenvvisitpre3, control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))
# Nan's produced
# mtnrange3 doesn't work

cupvp <- glmmTMB(NumIndSheep ~ vp..Pa. + (1|MtnRange), zi = ~ vp..Pa., family = nbinom2, data = ballenvvisitpre3, control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))
#Nans produced
# same for mtnrange3


cupndvi <- glmmTMB(NumIndSheep ~ MeanNDVI + (1|MtnRange), zi = ~ MeanNDVI, family = nbinom2, data = ballenvvisitpre3, control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))
summary(cupndvi)
# works! AIC 722 BIC 740.5
# doesn't work for mtnrange3

cup6precip <- glmmTMB(NumIndSheep ~ Precip6Wk + (1|MtnRange), zi = ~ Precip6Wk, family = nbinom2, data = ballenvvisitpre3, control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))
summary(cup6precip)
# works AIC 709.4, BIC 727.9
# works for mtnrange3

cupss <- glmmTMB(NumIndSheep ~ Precip6Wk + MeanNDVI + tmax..deg.c. + (1|MtnRange), zi = ~ Precip6Wk + MeanNDVI + tmax..deg.c., family = nbinom2, data = ballenvvisitpre3, control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))
summary(cupss)
# doesn't converge

cupsv <- glmmTMB(NumIndSheep ~ Precip6Wk + MeanNDVI + (1|MtnRange), zi = ~ Precip6Wk + MeanNDVI, family = nbinom2, data = ballenvvisitpre3, control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))
summary(cupsv)
# AIC 705.7, BIC 730.4

cupbv <- glmmTMB(NumIndSheep ~ Precip6Wk + tmax..deg.c. + (1|MtnRange), zi = ~ Precip6Wk + tmax..deg.c., family = nbinom2, data = ballenvvisitpre3, control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))
summary(cupbv)
# Nans produced

cupzs <- glmmTMB(NumIndSheep ~ MeanNDVI + tmax..deg.c. + (1|MtnRange), zi = ~ MeanNDVI + tmax..deg.c., family = nbinom2, data = ballenvvisitpre3, control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))
summary(cupzs)
# Nans produced

mtnrange3<- ballenvvisitpre3[ballenvvisitpre3$MtnRange == "Marb" | ballenvvisitpre3$MtnRange == "SBrs" | ballenvvisitpre3$MtnRange == "Nopa", ]

adprmd2 <- glmmTMB(NumIndSheep ~ tmax..deg.c. + MeanNDVI + Precip6Wk + (1|MtnRange), zi = ~tmax..deg.c. + MeanNDVI + Precip6Wk + (1|MtnRange), family = nbinom2, data = mtnrange3, control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))

summary(adprmd2)

# zi = ~tmax..deg.c. + MeanNDVI + Precip6Wk + (1|MtnRange)

adprmd2 <- glmmTMB(NumIndSheep ~ scaletmax + scalendvi + scale6wkprecip + (1|MtnRange), zi = ~scaletmax + scalendvi + scale6wkprecip, family = nbinom2, data = jball3)

adprmd2 <- glmmTMB(NumIndSheep ~ scaletmax  + (1|MtnRange), zi = ~scaletmax , family = nbinom2, data = jball3)
m1B <- update(adprmd2, control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))
summary(m1B)

adprmd2 <- glmmTMB(NumIndSheep ~ tmax..deg.c.  + (1|MtnRange), zi = ~tmax..deg.c. , family = nbinom2, data = jball3)
m1B <- update(adprmd2, control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))
summary(m1B)

dprmd2 <- zeroinfl(NumIndSheep ~ tmax..deg.c. + MeanNDVI + Precip6Wk | tmax..deg.c. + MeanNDVI + Precip6Wk + MtnRange, data = ballenvvisitpre3, dist = "negbin", link = "logit")


## Correlation between environmental variables including Precip6
library("Hmisc")
envvarnew <- ballenvvisitpre3[, c(12:14, 16:20)]
yik <- rcorr(as.matrix(envvarnew), type = "pearson")

## Adding in Precip6 to the distance to water ~ environmental variables analysis
# need to switch from xallenvvisit1 to ballenvvisitpre3

library(dplyr)
library(rsq)
ballenvvisitpre4 <- ballenvvisitpre3
names(ballenvvisitpre4)[names(ballenvvisitpre4) == "MtnRange"] <- "MountainRange"
xbcombined <- sort(union(levels(allcdi2$MountainRange), levels(ballenvvisitpre4$MountainRange)))
xmovenv <- left_join(mutate(allcdi2, MountainRange = factor(MountainRange, levels = xbcombined)), mutate(ballenvvisitpre4[, c("Date", "MountainRange", "dayl..s.", "prcp..mm.day.", "srad..W.m.2.", "tmax..deg.c.", "tmin..deg.c.", "vp..Pa.", "MeanNDVI", "Precip6Wk")], MountainRange = factor(MountainRange, levels = xbcombined)))
xmovenv$MeanClosedist[is.nan(xmovenv$MeanClosedist)] <- NA

library(pscl)
xdistenvnew <- glm(MeanClosedist ~ dayl..s. + srad..W.m.2. + tmin..deg.c. + tmax..deg.c. +  vp..Pa. + MeanNDVI + Precip6Wk + prcp..mm.day., data = xmovenv, na.action = na.exclude)
summary(xdistenvnew)
# R squared
with(summary(xdistenvnew), 1 - deviance/null.deviance)
BIC(xdistenvnew)

# Minus vp
xdistenvnew1 <- glm(MeanClosedist ~ dayl..s. + srad..W.m.2. + tmin..deg.c. + tmax..deg.c. + MeanNDVI + Precip6Wk + prcp..mm.day., data = xmovenv, na.action = na.exclude)
summary(xdistenvnew1)
# R squared
with(summary(xdistenvnew1), 1 - deviance/null.deviance)
BIC(xdistenvnew1)

# Minus prcp
xdistenvnew2 <- glm(MeanClosedist ~ dayl..s. + srad..W.m.2. + tmin..deg.c. + tmax..deg.c. + MeanNDVI + Precip6Wk, data = xmovenv, na.action = na.exclude)
summary(xdistenvnew2)
# R squared
with(summary(xdistenvnew2), 1 - deviance/null.deviance)
BIC(xdistenvnew2)

# Minus NDVI ** Similar AIC so this is the best one 1/29/22***
xdistenvnew3 <- glm(MeanClosedist ~ dayl..s. + srad..W.m.2. + tmin..deg.c. + tmax..deg.c. + Precip6Wk, data = xmovenv, na.action = na.exclude)
summary(xdistenvnew3)
BIC(xdistenvnew3)
# Higher BIC than xdistenvnew1

xdistenvnew4 <- glm(MeanClosedist ~ dayl..s. + srad..W.m.2. + tmin..deg.c. + tmax..deg.c. + Precip6Wk + MeanNDVI * Precip6Wk, data = xmovenv, na.action = na.exclude)
summary(xdistenvnew4)
BIC(xdistenvnew4)


#xdistenvnew2 <- glm(MeanClosedist ~ tmax..deg.c., data = xmovenv)

# Checking out distance to water by month
library(lubridate)
xmovenv$Month <- month(xmovenv$Date)
boxplot(MeanClosedist ~ Month, data = xmovenv, ylab = "Average distance to the nearest water source (m)")

# R squared
with(summary(xdistenvnew2), 1 - deviance/null.deviance)
plot(fitted(xdistenvnew2), resid(xdistenvnew2))
qqnorm(resid(xdistenvnew2))
qqline(resid(xdistenvnew2))
library(car)
qqPlot(resid(xdistenvnew2))

# Scaling to create beta coefficients/compare variable importance
jovenv <- xmovenv
jovenv$scaledayl <- scale(jovenv$dayl..s., center = TRUE, scale = TRUE)
jovenv$scaleprecip <- scale(jovenv$prcp..mm.day., center = TRUE, scale = TRUE)
jovenv$scalesrad <- scale(jovenv$srad..W.m.2., center = TRUE, scale = TRUE)
jovenv$scaletmax <- scale(jovenv$tmax..deg.c., center = TRUE, scale = TRUE)
jovenv$scaletmin <- scale(jovenv$tmin..deg.c., center = TRUE, scale = TRUE)
jovenv$scalevp <- scale(jovenv$vp..Pa., center = TRUE, scale = TRUE)
jovenv$scalendvi <- scale(jovenv$MeanNDVI, center = TRUE, scale = TRUE)
jovenv$scale6precip <- scale(jovenv$Precip6Wk, center = TRUE, scale = TRUE)

jdistenvnew <- glm(MeanClosedist ~ scaledayl + scalesrad + scaletmin + scaletmax + scale6precip, data = jovenv, na.action = na.exclude)
summary(jdistenvnew)
with(summary(jdistenvnew), 1 - deviance/null.deviance)
confint(jdistenvnew)

```


